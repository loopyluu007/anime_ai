# 健康检查优化方案

## 问题分析

当前项目的健康检查配置过于严格，导致应用在启动前就失败。主要问题如下：

### 1. Dockerfile中的健康检查问题
- **问题**: `--start-period=5s` 太短
- **原因**: Python应用（FastAPI/Uvicorn）需要时间：
  - 导入模块和依赖
  - 连接数据库（PostgreSQL）
  - 连接Redis
  - 初始化应用
  - 实际启动需要15-30秒甚至更长
- **影响**: 应用还在启动过程中就被标记为不健康，导致容器重启循环

### 2. docker-compose.yml中的健康检查问题
- **问题1**: 后端服务（agent_service, media_service, data_service）没有健康检查配置
- **问题2**: API Gateway使用 `condition: service_started` 而不是 `condition: service_healthy`
- **影响**: 
  - 无法检测后端服务的健康状态
  - API Gateway不会等待依赖服务完全健康就启动，可能导致连接失败

### 3. 基础设施服务的健康检查
- **状态**: 相对合理，但可以进一步优化

## 优化策略

### 核心理念："先跑起来、再调试"

1. **宽松的启动期（Start Period）**
   - 给应用充足的启动时间（30-60秒）
   - 避免在启动期间标记为不健康

2. **渐进式健康检查**
   - 启动期后开始检查
   - 使用合理的间隔和重试次数
   - 允许一定的失败重试

3. **合理的依赖关系**
   - 使用 `service_healthy` 确保依赖服务完全就绪
   - 但不过度依赖，允许一定的容错

## 具体优化方案

### 1. Dockerfile健康检查优化

**当前配置**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1
```

**优化后配置**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD curl -f http://localhost:8000/health || exit 1
```

**优化说明**:
- `--start-period=60s`: 增加启动宽限期到60秒
- `--retries=5`: 增加重试次数（从3次到5次）
- `--interval=30s`: 保持30秒间隔（合理）
- `--timeout=10s`: 保持10秒超时（合理）

### 2. docker-compose.yml健康检查优化

#### 2.1 后端服务添加健康检查

为 `agent_service`, `media_service`, `data_service` 添加健康检查：

```yaml
agent_service:
  # ... 其他配置
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s
```

#### 2.2 API Gateway依赖关系优化

将 `condition: service_started` 改为 `condition: service_healthy`:

```yaml
api_gateway:
  depends_on:
    agent_service:
      condition: service_healthy  # 从 service_started 改为 service_healthy
    media_service:
      condition: service_healthy
    data_service:
      condition: service_healthy
```

### 3. 基础设施服务优化（可选）

保持现有配置，但可以稍微调整：

```yaml
postgres:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-directorai}"]
    interval: 10s
    timeout: 5s
    retries: 5  # 从5次保持不变，合理
    start_period: 10s  # 可以添加启动期（PostgreSQL通常启动较快）
```

## 实施步骤

1. ✅ 分析当前配置
2. ⏳ 更新所有Dockerfile的健康检查配置
3. ⏳ 更新docker-compose.yml添加后端服务健康检查
4. ⏳ 优化API Gateway的依赖关系
5. ⏳ 测试验证

## 预期效果

### 改进前
- 应用启动时经常因为健康检查失败而重启
- 启动成功率低
- 调试困难（容器不断重启）

### 改进后
- 应用有充足的启动时间（60秒）
- 启动成功率提高
- 可以正常启动后再进行调试
- 依赖服务健康后才启动上游服务
- 更稳定的服务编排

## 配置对比表

| 配置项 | 优化前 | 优化后 | 说明 |
|--------|--------|--------|------|
| start-period | 5s | 60s | 给应用充足启动时间 |
| retries | 3 | 5 | 增加容错能力 |
| interval | 30s | 30s | 保持不变（合理） |
| timeout | 10s | 10s | 保持不变（合理） |
| depends_on | service_started | service_healthy | 确保依赖服务完全就绪 |
| docker-compose健康检查 | 部分服务缺失 | 所有服务都有 | 完整的健康检查覆盖 |

## 注意事项

1. **开发环境**: 可以考虑更宽松的配置（如start-period=90s）
2. **生产环境**: 60秒启动期对于大多数应用已经足够
3. **监控**: 即使健康检查宽松，仍需要监控应用实际启动时间
4. **日志**: 如果启动时间超过60秒，需要查看日志排查问题

## 后续优化建议

1. **启动时间监控**: 记录实际启动时间，优化启动性能
2. **健康检查端点增强**: 可以检查数据库连接、Redis连接等
3. **优雅关闭**: 确保应用可以优雅关闭
4. **资源限制**: 考虑添加资源限制，避免资源不足导致启动慢
