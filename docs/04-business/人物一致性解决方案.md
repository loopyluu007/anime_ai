# 人物一致性解决方案

## 🎯 问题：如何让7个场景视频里的"小姐姐"长得一模一样？

---

## 💡 核心方案：一张"角色身份证"

```
┌──────────────────────────────────────────────────┐
│                                                  │
│            角色三视图 = 人物的"身份证"            │
│                                                  │
│   ┌───────────┐    ┌───────────┐    ┌───────────┐│
│   │           │    │           │    │           ││
│   │   正面    │    │   侧面    │    │   背面    ││
│   │   Front   │    │   Side    │    │   Back    ││
│   │           │    │           │    │           ││
│   │  😊       │    │  👃       │    │  🌱       ││
│   │           │    │           │    │           ││
│   └───────────┘    └───────────┘    └───────────┘│
│        ↑               ↑               ↑          │
│     左边            中间            右边          │
│                                                  │
└──────────────────────────────────────────────────┘

这张图片包含：同一个人的 3 个角度
→ AI 看到后，就知道这个人的完整长相了！
```

---

## 📋 完整流程图

```mermaid
flowchart TD
    Start([用户上传照片<br/>可选]) --> AI1[第一步: AI写剧本]

    AI1 --> AI1_1[智谱 AI 分析<br/>提取人物特征]
    AI1_1 --> AI1_2[描述: 可爱女孩<br/>棕色长发, 粉色围裙]

    AI1_2 --> AI2[第二步: 生成角色身份证]
    AI2 --> AI2_1[根据描述生成<br/>正面+侧面+背面<br/>合并在一张图上]

    AI2_1 --> AI3[第三步: 生成7张场景图]

    AI3 --> S1[场景1图]
    AI3 --> S2[场景2图]
    AI3 --> S3[场景3图]
    AI3 --> S4[场景4图]
    AI3 --> S5[场景5图]
    AI3 --> S6[场景6图]
    AI3 --> S7[场景7图]

    S1 --> M1[用什么生成?<br/>用户上传的照片 + AI描述]
    S2 --> M2[用什么生成?<br/>角色身份证 + AI描述]
    S3 --> M3[用什么生成?<br/>角色身份证 + AI描述]
    S4 --> M4[用什么生成?<br/>角色身份证 + AI描述]
    S5 --> M5[用什么生成?<br/>角色身份证 + AI描述]
    S6 --> M6[用什么生成?<br/>角色身份证 + AI描述]
    S7 --> M7[用什么生成?<br/>角色身份证 + AI描述]

    M1 --> V1[第四步: 生成视频]
    M2 --> V2
    M3 --> V3
    M4 --> V4
    M5 --> V5
    M6 --> V6
    M7 --> V7

    V1 --> R1[参考图: 身份证 + 场景1图]
    V2 --> R2[参考图: 身份证 + 场景2图]
    V3 --> R3[参考图: 身份证 + 场景3图]
    V4 --> R4[参考图: 身份证 + 场景4图]
    V5 --> R5[参考图: 身份证 + 场景5图]
    V6 --> R6[参考图: 身份证 + 场景6图]
    V7 --> R7[参考图: 身份证 + 场景7图]

    R1 --> End[✅ 7个场景视频完成<br/>人物长相完全一致!]
    R2 --> End
    R3 --> End
    R4 --> End
    R5 --> End
    R6 --> End
    R7 --> End

    classDef startEnd fill:#ec4899,stroke:#be185d,color:#fff;font-size:16px
    classDef step fill:#3b82f6,stroke:#2563eb,color:#fff;font-size:15px
    classDef scene fill:#f59e0b,stroke:#d97706,color:#fff;font-size:14px
    classDef method fill:#8b5cf6,stroke:#7c3aed,color:#fff;font-size:13px
    classDef result fill:#10b981,stroke:#059669,color:#fff;font-size:14px

    class Start,End startEnd
    class AI1,AI1_1,AI1_2,AI2,AI2_1,AI3,V1,V2,V3,V4,V5,V6,V7 step
    class S1,S2,S3,S4,S5,S6,S7 scene
    class M1,M2,M3,M4,M5,M6,M7,R1,R2,R3,R4,R5,R6,R7 method
```

---

## 🔍 核心概念：角色三视图

### 什么是"组合三视图"？

一张图片包含三个视角：
```
┌─────────────────────────────────────────┐
│                                         │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│   │         │    │         │    │         │  │
│   │  正面   │    │  侧面   │    │  背面   │  │
│   │ Front   │    │  Side   │    │  Back   │  │
│   │         │    │         │    │         │  │
│   └─────────┘    └─────────┘    └─────────┘  │
│      LEFT          CENTER          RIGHT     │
│                                         │
└─────────────────────────────────────────┘
```

**为什么这样设计？**
- ✅ 一张图包含三个角度，确保 AI 学习完整的人物特征
- ✅ 后续图生图时，AI 能理解人物的多角度外观
- ✅ 比生成三张独立图片更高效

### 数据模型

```dart
class CharacterSheet {
  final String characterId;      // 角色ID: "char_001"
  final String characterName;     // 角色名称: "草莓女孩"
  final String description;       // 角色描述

  // 核心字段：组合三视图 URL
  String? combinedViewUrl;        // "https://cdn.example.com/turnaround_001.jpg"

  // 旧版字段（已废弃，保留兼容）
  @Deprecated('使用 combinedViewUrl 替代')
  String? frontViewUrl;
  @Deprecated('使用 combinedViewUrl 替代')
  String? sideViewUrl;
  @Deprecated('使用 combinedViewUrl 替代')
  String? backViewUrl;
}
```

---

## 📝 详细步骤说明

### 第一步：AI 写剧本

```
你输入: "生成一个小姐姐做草莓蛋糕的视频"
          ↓
智谱 AI 分析:
  - 人物: 可爱女孩，棕色长发，粉色围裙
  - 场景: 厨房
  - 故事: 准备材料 → 混合 → 烘烤 → 装饰 → 品尝
          ↓
输出: 7 个场景的剧本
```

**剧本内容**:
```json
场景1: 女孩走进厨房，系上粉色围裙
场景2: 准备面粉、鸡蛋、草莓
场景3: 混合材料
场景4: 烘烤蛋糕
场景5: 装饰草莓
场景6: 切蛋糕
场景7: 品尝蛋糕
```

**GLM-4.7 AI 返回的剧本**:
```json
{
  "scenes": [
    {
      "scene_id": 1,
      "narration": "走进厨房，准备做蛋糕",
      "character_description": "一位可爱的年轻女性，约20岁，有着柔顺的棕色长发，明亮的眼睛，穿着粉色围裙"
    }
  ]
}
```

**关键**: `character_description` 字段包含人物特征描述

---

### 第二步：提取主要角色并生成角色身份证

#### 提取主要角色

**代码逻辑**:
```dart
// lib/controllers/screenplay_draft_controller.dart:328-422
List<Map<String, String>> _extractMainCharacters(ScreenplayDraft draft) {
  // 1. 获取第一个场景的角色描述
  String? characterDesc = draft.scenes.first.characterDescription;

  // 2. 智能分割多个角色（按句号、分号）
  final characters = characterDesc.split(/\.|;/);

  // 3. 最多提取2个角色
  return characters.take(2).map((desc) => {
    'name': '角色${index + 1}',
    'description': desc,
    'role': index == 0 ? '主角' : '第二主角',
  }).toList();
}
```

#### 生成角色三视图

```
剧本中的人物描述
  ↓
"可爱女孩，棕色长发，粉色围裙"
  ↓
AI 生成三视图:
  ┌─────────────────────────────────┐
  │ 正面 │ 侧面 │ 背面 │ (在一张图上)  │
  └─────────────────────────────────┘
  ↓
保存为: character_turnaround.jpg
```

**这就是"角色身份证"！**

**提示词构建**:
```dart
// lib/services/api_service.dart:1830-1851
String _buildCombinedViewPrompt(String characterDesc) {
  return '''
Character turnaround sheet with three views of the same character arranged horizontally:
- LEFT: Front view
- CENTER: Side view (profile)
- RIGHT: Back view

Character: $characterDesc

Style: Clean anime style, consistent lighting, white background, high quality.
Ensure the character's face, hair, and outfit are clearly visible in all three views.
''';
}
```

**API 调用**:
```dart
// 使用用户上传的原图作为参考
final imageUrl = await generateImage(
  prompt: combinedViewPrompt,
  referenceImages: userUploadedImage,  // 图生图
);
```

**返回结果**:
```dart
CharacterSheet {
  characterId: "char_001",
  characterName: "草莓女孩",
  combinedViewUrl: "https://cdn.example.com/turnaround_char_001.jpg",
  status: completed
}
```

**为什么需要三视图?**
- 正面 → AI 知道脸长什么样
- 侧面 → AI 知道鼻子、下巴的轮廓
- 背面 → AI 知道发型、衣服背面
- 三个角度结合 → AI 完全理解这个人的长相！

---

### 第三步：生成 7 张场景图

#### 场景 1 - 特殊处理

```
场景 1: "女孩走进厨房，系上粉色围裙"

输入:
  ✅ 用户上传的照片 (如果有)
  ✅ 角色身份证
  ✅ 场景描述

生成:
  📸 场景1图片.jpg
```

**为什么场景1特殊？**
- 如果用户上传了照片，场景1优先用用户照片
- 这样生成的女孩更像用户想要的样子

**代码实现**:
```dart
// lib/controllers/screenplay_controller.dart
if (sceneIndex == 0 && userOriginalImages != null) {
  // 场景1：使用用户原图进行图生图
  imageUrl = await _apiService.generateImage(
    scene.imagePrompt,
    referenceImages: userOriginalImages,  // 用户上传的原图
  );
}
```

**请求格式**:
```json
{
  "model": "gemini-2.5-flash-image-vip",
  "prompt": "A cute girl in modern kitchen, tying pink apron, warm lighting",
  "image": "https://user-upload.example.com/reference.jpg"
}
```

#### 场景 2-7 - 标准流程

```
场景 2: "准备面粉、鸡蛋、草莓"

输入:
  ✅ 角色身份证 (正面+侧面+背面)
  ✅ 场景描述

生成:
  📸 场景2图片.jpg
```

**策略**: 后续场景使用角色三视图保持一致性

**代码实现**:
```dart
// lib/controllers/screenplay_controller.dart
if (sceneIndex > 0 && characterReferenceUrls != null) {
  // 场景2+：使用角色三视图进行图生图
  imageUrl = await _apiService.generateImageWithCharacterReference(
    scene.imagePrompt,
    characterImageUrls: characterReferenceUrls,  // [combinedViewUrl]
  );
}
```

**请求格式** (Chat API):
```json
{
  "model": "gpt-4o-image-vip",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Girl mixing flour in a bowl, kitchen scene"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "https://cdn.example.com/turnaround_char_001.jpg"
          }
        }
      ]
    }
  ]
}
```

**为什么这样有效？**
- AI 看到了角色的正面、侧面、背面三个视角
- 理解了人物的多角度外观
- 生成新场景时会自动保持人物特征

**重复这个步骤，生成 7 张场景图**

```
┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ 场景1图 │ 场景2图 │ 场景3图 │ 场景4图 │ 场景5图 │ 场景6图 │ 场景7图 │
│ 厨房   │ 准备   │ 混合   │ 烘烤   │ 装饰   │ 切蛋糕 │ 品尝   │
└─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘

所有图里的女孩，长得一模一样！
因为都用了同一个"角色身份证"
```

---

### 第四步：生成 7 个视频

每个场景图 → 动态视频

```
场景1图 + 角色身份证
  ↓
输入给 AI:
  参考图1: 角色身份证 (正面+侧面+背面)
  参考图2: 场景1图 (女孩在厨房)
  动作描述: "女孩系围裙，微笑"
  ↓
输出:
  🎬 场景1视频.mp4 (5秒)
```

**为什么视频还需要角色身份证？**

```
场景图是静止的
视频是动态的，人物会动、会转头

如果只用场景图:
  人物转头后 → AI 可能画成另一张脸 ❌

有了角色身份证:
  AI 知道正面、侧面、背面都长什么样
  人物怎么动 → 脸都不会变 ✅
```

**参考图组合策略**:

```
角色三视图 (最多2张) + 当前场景图 (1张) = 最多3张参考图
```

**代码实现**:
```dart
// lib/controllers/screenplay_controller.dart:274-297
// 构建参考图列表
final List<String> referenceUrls = [];

// 1. 添加角色三视图（支持双主角）
referenceUrls.addAll(characterUrls);  // 最多2张

// 2. 添加当前场景的分镜图
if (imageUrl != null) {
  referenceUrls.add(imageUrl);  // 1张
}

// 总计：最多3张参考图
AppLogger.info('视频生成', '场景 $sceneNum 参考图: ${referenceUrls.length} 张');

final videoResponse = await _apiService.generateVideo(
  imageUrls: referenceUrls,  // [三视图, 场景图]
  prompt: scene.videoPrompt,
  seconds: '5',
  model: 'veo3.1-components',  // 支持多图参考的模型
);
```

**API 请求**:
```http
POST /v1/videos
Content-Type: multipart/form-data

model=veo3.1-components
prompt=Girl whisking eggs, dynamic camera movement, flour dusting effect
seconds=5
size=1280x720
input_reference=https://cdn.example.com/turnaround_char_001.jpg
input_reference=https://cdn.example.com/scene_1.jpg
```

**veo3.1-components 模型特点**:
- ✅ 支持多张图片作为参考（最多3张）
- ✅ 能综合所有参考图的人物特征
- ✅ 生成视频时保持人物外观一致

---

## 🎬 双主角支持

当剧本中有2个主要角色时：

```dart
// 角色1：草莓女孩
CharacterSheet {
  characterId: "char_001",
  combinedViewUrl: "https://cdn.example.com/turnaround_001.jpg"
}

// 角色2：助手小明
CharacterSheet {
  characterId: "char_002",
  combinedViewUrl: "https://cdn.example.com/turnaround_002.jpg"
}
```

**视频生成时的参考图**:
```dart
referenceUrls = [
  "https://cdn.example.com/turnaround_001.jpg",  // 角色1三视图
  "https://cdn.example.com/turnaround_002.jpg",  // 角色2三视图
  "https://cdn.example.com/scene_5.jpg"          // 当前场景图
]
// 共3张，达到上限
```

---

## 🔄 降级策略

当没有用户上传图片时，如何保证一致性？

```dart
// lib/controllers/screenplay_controller.dart
Future<String> generateSceneImage(Scene scene, int sceneIndex) async {
  // 策略1: 有用户原图 -> 使用原图（场景1）
  if (sceneIndex == 0 && _userOriginalImages != null) {
    return await _apiService.generateImage(
      scene.imagePrompt,
      referenceImages: _userOriginalImages,
    );
  }

  // 策略2: 有角色三视图 -> 使用三视图（场景2+）
  if (_characterReferenceUrls != null && _characterReferenceUrls!.isNotEmpty) {
    return await _apiService.generateImageWithCharacterReference(
      scene.imagePrompt,
      characterImageUrls: _characterReferenceUrls!,
    );
  }

  // 策略3: 无参考图 -> 纯文本生成（降级）
  return await _apiService.generateImage(scene.imagePrompt);
}
```

**降级后果**:
- ❌ 场景之间的人物可能不一致
- ⚠️ 仅依赖 prompt 中的文字描述
- 💡 建议：用户上传参考图以获得最佳效果

---

## 🎬 对比：有身份证 vs 没身份证

```
┌─────────────────────────────────────────────────────────┐
│                   没有身份证                            │
├─────────────────────────────────────────────────────────┤
│ 场景1: 棕发女孩                                          │
│ 场景2: 黑发女孩  ← 怎么变黑了？                         │
│ 场景3: 眼睛变大了 ← 好像不是同一个人                    │
│ 场景4: 短发女孩 ← 发型也不对                            │
│                                                         │
│ 结果: 7个场景像7个不同的人在演 ❌                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   有身份证                              │
├─────────────────────────────────────────────────────────┤
│ 场景1: 棕发女孩                                          │
│ 场景2: 棕发女孩 ← 一样！                                │
│ 场景3: 棕发女孩 ← 还是一样！                            │
│ 场景4: 棕发女孩 ← 全部一样！                            │
│                                                         │
│ 结果: 7个场景是同一个人在演 ✅                           │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 核心原理：图生图技术

```
什么是"图生图"？

普通生成:
  文字描述 → AI 凭空画一张图

图生图:
  参考图片 + 文字描述 → AI 参考图片的风格和人物画新图

例子:
  参考图: 一个棕色长发女孩的照片
  描述: "这个女孩在厨房系围裙"
  结果: 生成的女孩和参考图里长得一模一样，只是场景变了
```

### 本项目的三种图生图方式

| 方式 | 参考图 | 用在哪个场景 |
|------|--------|-------------|
| **用户原图 → 场景图** | 用户上传的照片 | 场景1 |
| **身份证 → 场景图** | 角色三视图 | 场景2-7 |
| **身份证+场景图 → 视频** | 三视图+场景图 | 所有场景 |

---

## 📊 技术架构

```mermaid
graph LR
    subgraph 用户输入
        A[用户上传照片<br/>可选]
    end

    subgraph 第一步: 剧本生成
        B[智谱 GLM-4.7<br/>分析人物特征]
    end

    subgraph 第二步: 身份证生成
        C[Gemini AI<br/>生成三视图]
    end

    subgraph 第三步: 场景图生成
        D1[场景1: 用户原图]
        D2[场景2-7: 身份证]
    end

    subgraph 第四步: 视频生成
        E[Sora AI<br/>身份证+场景图]
    end

    A --> B
    B --> C
    C --> D1
    C --> D2
    D1 --> E
    D2 --> E

    classDef input fill:#ec4899,stroke:#be185d,color:#fff
    classDef ai fill:#8b5cf6,stroke:#7c3aed,color:#fff
    classDef output fill:#10b981,stroke:#059669,color:#fff

    class A input
    class B,C,E ai
    class D1,D2 output
```

---

## 📊 数据流图

```mermaid
sequenceDiagram
    participant U as 👤 用户
    participant G as 🤖 GLM-4.7
    participant T as 🎨 三视图生成
    participant S as 🎬 场景生成
    participant V as 🎥 视频生成

    U->>G: 输入: "生成做蛋糕视频"
    G-->>U: 剧本 + 角色描述

    U->>T: 上传参考图 (可选)
    T->>T: 生成组合三视图
    T-->>S: combinedViewUrl

    Note over S: 场景1
    S->>S: 使用用户原图图生图
    S-->>V: 场景1图片

    Note over S: 场景2-7
    S->>S: 使用三视图图生图
    S-->>V: 场景2-7图片

    V->>V: 三视图+场景图 → 视频
    V-->>U: 7个场景视频
```

---

## 🔧 技术要点

### 1. Chat API vs 生成 API

| API | 用途 | 特点 |
|-----|------|------|
| `gemini-2.5-flash-image-vip` | 简单图生图 | 单张参考图 |
| `gpt-4o-image-vip` (Chat) | 多模态图生图 | 支持多张参考图 |

**为什么场景2+使用 Chat API？**
- ✅ 可传入多个图片 URL
- ✅ content 数组格式：`[{type: "text"}, {type: "image_url"}]`
- ✅ 更适合角色参考场景

### 2. 多图参考模型

| 模型 | 支持图片数 | 用途 |
|-----|-----------|------|
| `veo3.1` | 1张 | 简单图生视频 |
| `veo3.1-components` | 最多3张 | 多图参考（推荐） |
| `sora-1` | 1张 | OpenAI Sora |

**项目选择**: `veo3.1-components`
- 支持 `input_reference` 字段重复传值
- 可同时接收角色三视图 + 场景图

### 3. 请求格式对比

**图片生成 (场景1)**:
```json
{
  "model": "gemini-2.5-flash-image-vip",
  "prompt": "...",
  "image": "https://url"
}
```

**图片生成 (场景2+)**:
```json
{
  "model": "gpt-4o-image-vip",
  "messages": [{
    "role": "user",
    "content": [
      {"type": "text", "text": "..."},
      {"type": "image_url", "image_url": {"url": "..."}}
    ]
  }]
}
```

**视频生成**:
```http
POST /v1/videos
input_reference=https://url1
input_reference=https://url2
input_reference=https://url3
```

---

## 🎯 关键要点总结

### 用大白话解释

```
1️⃣ 你告诉 AI: "我要一个做蛋糕的视频"
2️⃣ AI 写好剧本，提取人物: "棕色长发女孩，粉色围裙"
3️⃣ AI 生成一张"角色身份证" (正面+侧面+背面)
4️⃣ 用身份证生成7张场景图 (每张图的人长得一样)
5️⃣ 用身份证+场景图生成7个视频 (视频中的人也长得一样)
6️⃣ 合并成完整视频 ✅
```

### 为什么这样有效？

```
身份证 = 人物的"标准照"

每次生成新内容时，AI 都看一眼身份证:
"哦，要画这个女孩啊，我知道她长什么样"

所以不管生成多少场景，永远是同一个人！
```

### 口诀记忆

```
一张身份证，三个角度看
七场图生图，张张都一样
视频再加码，动态也不变
最后合起来，完美短视频
```

---

## 💡 使用建议

| 你做什么 | 效果 |
|---------|------|
| ✅ 上传清晰的正面人物照 | 效果最佳 ⭐⭐⭐⭐⭐ |
| ✅ 照片里的人正面朝向 | 三视图生成更准确 |
| ✅ 照片背景简洁 | AI 更容易提取人物特征 |
| ❌ 不上传照片 | AI 凭想象生成，效果一般 ⭐⭐⭐ |
| ❌ 照片多人或背影 | 可能识别错人物 ⭐⭐ |

---

## 📁 关键代码位置

| 功能 | 文件路径 | 关键方法/行号 |
|------|---------|--------------|
| 角色模型 | `lib/models/character_sheet.dart` | CharacterSheet |
| 提取角色 | `lib/controllers/screenplay_draft_controller.dart` | `_extractMainCharacters():328` |
| 生成三视图 | `lib/controllers/screenplay_draft_controller.dart` | `generateCharacterSheets():290` |
| 构建提示词 | `lib/services/api_service.dart` | `_buildCombinedViewPrompt():1830` |
| 图生图(多图) | `lib/services/api_service.dart` | `generateImageWithCharacterReference():1580` |
| 场景生成 | `lib/controllers/screenplay_controller.dart` | `generateFromConfirmed():136` |
| 视频生成 | `lib/services/api_service.dart` | `generateVideo():1966` |

---

## 💡 总结

### 人物一致性 = 三层保障

1. **角色三视图** 🔑
   - 一张图包含正面、侧面、背面
   - AI 学习完整的人物多角度特征

2. **场景图片** 🖼️
   - 场景1: 用户原图 → 图生图
   - 场景2+: 三视图 → 图生图

3. **场景视频** 🎬
   - 参考图: 三视图(2张) + 场景图(1张)
   - 使用 veo3.1-components 模型

### 最佳实践

| 操作 | 效果 |
|------|------|
| ✅ 上传清晰的正面人物照 | 人物一致性最佳 |
| ✅ 参考图中人物正面朝向 | 三视图生成效果更好 |
| ❌ 不上传参考图 | 降级为纯文本，一致性无法保证 |
| ❌ 参考图多人或背影 | AI 可能混淆角色特征 |

### 流程口诀

```
用户传图生三图，
场景一用原图输，
场景二到七用图，
视频三图保一致。
```

---

**文档版本**: v2.0  
**最后更新**: 2025-01-15  
**维护者**: 开发团队
