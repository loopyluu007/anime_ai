# AI漫导 架构拆分总览

> **项目**: AI漫导 (DirectorAI)  
> **目标**: 将 Flutter 单体应用拆分为三大低耦合模块  
> **版本**: v1.0  
> **日期**: 2026-01-12

---

## 📚 文档索引

本文档是架构拆分方案的入口文档，包含所有相关文档的索引和快速导航。

> **💡 AI Agent 开发提示**: 如果你是 AI Agent 准备继续开发，请先阅读 [AI_Agent开发指南.md](../AI_Agent开发指南.md) 获取文档阅读顺序和开发指导。

### 核心架构文档

1. **[架构拆分方案](./架构拆分方案.md)** ⭐
   - 整体架构设计
   - 模块划分
   - 技术栈选型
   - 拆分步骤
   - 迁移策略

2. **[API接口设计文档](../03-api-database/API接口设计文档.md)**
   - RESTful API 设计
   - WebSocket 实时通信
   - 请求/响应格式
   - 错误码定义

3. **[数据库设计文档](../03-api-database/数据库设计文档.md)**
   - 表结构设计
   - 索引设计
   - 关系图
   - 数据迁移

4. **[项目结构规划](./项目结构规划.md)**
   - 后端服务结构
   - 移动端结构
   - Web 端结构
   - 共享资源

---

## 📊 项目进度总览

> **最后更新**: 2026-01-12

### 模块设计状态

| 模块 | 设计状态 | 开发状态 | 说明 |
|------|---------|---------|------|
| **API Gateway** | ✅ 已完成 | ✅ 已完成 | 认证、限流、路由转发 |
| **Agent Service** | ✅ 已完成 | ✅ 已完成 | 对话、任务、剧本管理 |
| **Media Service** | ✅ 已完成 | ✅ 已完成 | 图片生成、视频生成 |
| **Data Service** | ✅ 已完成 | ✅ 已完成 | 用户数据管理 |
| **移动端 App** | ✅ 已完成 | ⏸️ 搁置 | Flutter 移动端（代码已保留，开发已搁置） |
| **Web 端 App** | ✅ 已完成 | ❌ 待开发 | Flutter Web 响应式应用 |

**图例**：
- ✅ 已完成 - 设计和/或开发已完成
- ⏳ 部分完成 - 部分功能已完成
- ❌ 待开发 - 尚未开始开发

### 开发进度统计

- **已设计模块**: 6/6 (100%)
- **已开发模块**: 4/6 (67%)
- **待开发模块**: 2/6 (33%)

### 详细进度

#### 后端服务（✅ 已完成）

- ✅ API Gateway - 已完成
- ✅ Agent Service - 已完成
- ✅ Media Service - 已完成
- ✅ Data Service - 已完成

**详情**: 查看 [后端开发文档](../../backend/DEVELOPMENT.md#api实现状态)

#### 前端应用

- ⏸️ **移动端 App** - 已搁置
  - ✅ 基础功能已完成（单体应用，代码已保留）
  - ⏸️ ~~待重构为微服务架构~~（开发已搁置）
  - ⏸️ ~~待移除直接 API 调用~~（开发已搁置）
  - **状态说明**: 移动端开发已标记为搁置，暂时不需要开发，未来很长一段时间内不会需要。但已编写的代码将保留在代码库中。
  
- ❌ **Web 端 App** - 待开发
  - ❌ 项目初始化
  - ❌ Web 适配层
  - ❌ 响应式布局
  - ❌ PWA 配置

**详情**: 查看 [工程实施索引](../02-implementation/工程实施索引.md#实施计划)

---

## 🎯 拆分目标

### 当前状态（单体应用）

```
┌─────────────────────────────────────┐
│    Flutter 移动端应用（单体）          │
│  - 直接调用第三方 API                 │
│  - API Key 暴露在前端                 │
│  - 业务逻辑与 UI 耦合                 │
│  - Web 端适配困难                     │
└─────────────────────────────────────┘
```

### 目标架构（微服务）

```
┌──────────────┐         ┌──────────────┐
│  移动 App 端  │         │  响应式 Web 端 │
│  (Flutter)   │         │ (Flutter Web)│
└──────┬───────┘         └──────┬───────┘
       │                         │
       └───────────┬─────────────┘
                   │
         ┌─────────▼─────────┐
         │   服务器后端        │
         │  (Python/Node.js)  │
         │  - API Gateway     │
         │  - 业务服务         │
         │  - 媒体服务         │
         │  - 数据服务         │
         └────────────────────┘
```

---

## 📦 三大模块

### 1. 服务器后端 (Backend Service)

**职责**:
- API 网关（认证、限流、路由）
- 业务服务（Agent 编排、剧本生成、对话管理）
- 媒体服务（图片生成、视频生成）
- 数据服务（用户数据、对话历史、任务管理）

**技术栈**:
- Python (FastAPI) 或 Node.js (NestJS)
- PostgreSQL + Redis
- Docker + Docker Compose

**文档**: 详见 [架构拆分方案](./架构拆分方案.md#1-服务器后端-backend-service)

---

### 2. 移动 App 端 (Mobile App)

**职责**:
- UI 展示（聊天界面、剧本预览、设置页面）
- 用户交互（输入处理、手势操作、离线缓存）
- 状态管理（本地状态、API 调用、数据同步）
- 平台特性（推送通知、相机访问、文件下载）

**技术栈**:
- Flutter 3.0+
- Provider (状态管理)
- Dio (网络请求)
- Hive (本地存储)

**文档**: 详见 [架构拆分方案](./架构拆分方案.md#2-移动-app-端-mobile-app)

---

### 3. 响应式 Web 端 (Web App)

**职责**:
- 响应式 UI（适配桌面、平板、移动浏览器）
- 用户交互（键盘操作、鼠标交互、触摸支持）
- 状态管理（与移动端共享业务逻辑）
- Web 特性（PWA、SEO、分享功能）

**技术栈**:
- Flutter Web 3.0+
- Provider (状态管理，与移动端共享)
- Dio (网络请求，与移动端共享)
- IndexedDB (Web 存储)

**文档**: 详见 [架构拆分方案](./架构拆分方案.md#3-响应式-web-端-web-app)

---

## 🔌 模块间通信

### HTTP API

- **协议**: HTTPS
- **格式**: JSON
- **认证**: JWT Bearer Token
- **基础路径**: `https://api.directorai.com/api/v1`

**详细文档**: [API接口设计文档](../03-api-database/API接口设计文档.md)

### WebSocket

- **协议**: WSS (WebSocket Secure)
- **用途**: 实时任务进度、消息推送
- **连接**: `wss://api.directorai.com/ws?token={jwt_token}`

**详细文档**: [API接口设计文档 - WebSocket](./API接口设计文档.md#websocket-实时通信)

---

## 📊 数据流

### 用户创建任务流程

```
1. 用户输入提示词
   ↓
2. 移动端/Web端 → POST /api/v1/tasks
   ↓
3. 后端接收请求，创建任务
   ↓
4. 后端调用 GLM API 生成剧本
   ↓
5. WebSocket 推送进度更新
   ↓
6. 后端调用图片生成 API
   ↓
7. WebSocket 推送图片生成进度
   ↓
8. 后端调用视频生成 API
   ↓
9. WebSocket 推送视频生成进度
   ↓
10. 任务完成，WebSocket 推送完成通知
    ↓
11. 前端获取任务结果，展示给用户
```

---

## 🗄️ 数据存储

### 数据库

- **主数据库**: PostgreSQL 15+
  - 用户数据
  - 对话历史
  - 任务记录
  - 剧本数据

- **缓存**: Redis 7+
  - 会话缓存
  - 任务队列
  - 限流计数

**详细文档**: [数据库设计文档](../03-api-database/数据库设计文档.md)

### 文件存储

- **开发环境**: MinIO (本地对象存储)
- **生产环境**: AWS S3 或 阿里云 OSS
- **存储内容**:
  - 用户上传的参考图片
  - 生成的图片
  - 生成的视频
  - 合并后的视频

---

## 🚀 实施计划

### 阶段一：后端服务搭建（2-3 周）

- [ ] 搭建后端项目框架
- [ ] 配置数据库和缓存
- [ ] 实现认证授权
- [ ] 实现核心业务服务
- [ ] 实现媒体服务
- [✅] 实现 WebSocket 实时推送

### 阶段二：移动端重构（2-3 周）⏸️ 已搁置

> **状态说明**: 移动端开发已标记为搁置，暂时不需要开发，未来很长一段时间内不会需要。但已编写的代码将保留在代码库中。

- [⏸️] ~~创建 API 客户端~~（开发已搁置）
- [⏸️] ~~迁移对话功能~~（开发已搁置）
- [⏸️] ~~迁移剧本功能~~（开发已搁置）
- [⏸️] ~~移除直接 API 调用~~（开发已搁置）
- [⏸️] ~~优化离线缓存~~（开发已搁置）

### 阶段三：Web 端开发（2-3 周）

- [ ] 创建 Web 项目
- [ ] 实现 Web 适配器
- [ ] 复用移动端业务逻辑（移动端代码已保留，可参考）
- [ ] 实现响应式布局
- [ ] 配置 PWA

### 阶段四：集成测试（1 周）

- [ ] 端到端测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 用户体验测试

**详细计划**: 详见 [架构拆分方案 - 拆分步骤](./架构拆分方案.md#拆分步骤)

---

## 📁 项目结构

### 整体目录

```
anime_ai/
├── backend/          # 后端服务
├── mobile-app/       # 移动端应用
├── web-app/          # Web 端应用
├── shared/           # 共享资源
└── docs/             # 项目文档
```

**详细结构**: 详见 [项目结构规划](./项目结构规划.md)

---

## 🔐 安全考虑

### API 安全

- ✅ HTTPS 强制加密
- ✅ JWT Token 认证
- ✅ API 限流（防止滥用）
- ✅ CORS 跨域控制
- ✅ 输入验证和清理

### 数据安全

- ✅ 密码使用 bcrypt 哈希
- ✅ 敏感数据加密存储
- ✅ 数据库连接使用 SSL
- ✅ 定期数据备份

### 部署安全

- ✅ Docker 容器隔离
- ✅ 环境变量管理密钥
- ✅ 日志不记录敏感信息
- ✅ 定期安全更新

---

## 📈 性能优化

### 后端优化

- **数据库**: 索引优化、查询优化、连接池
- **缓存**: Redis 缓存热点数据
- **异步处理**: 任务队列处理耗时操作
- **CDN**: 静态资源和媒体文件使用 CDN

### 前端优化

- **代码分割**: 按需加载
- **图片优化**: 懒加载、压缩、WebP 格式
- **视频优化**: 流式加载、多码率
- **缓存策略**: 本地缓存、HTTP 缓存

---

## 🧪 测试策略

### 单元测试

- 后端: Python pytest / Node.js Jest
- 前端: Flutter test

### 集成测试

- API 接口测试
- 数据库集成测试
- 第三方 API Mock

### 端到端测试

- 用户流程测试
- 跨平台测试
- 性能测试

---

## 📝 开发规范

### 代码规范

- **后端**: PEP 8 (Python) / ESLint (Node.js)
- **前端**: Dart linter rules
- **Git**: Conventional Commits

### API 规范

- RESTful 设计原则
- 统一响应格式
- 版本控制（/api/v1/）

### 文档规范

- API 文档（OpenAPI/Swagger）
- 代码注释
- 架构文档

---

## 🔄 版本管理

### 版本号规则

- **主版本号**: 不兼容的 API 修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

### 分支策略

- `main`: 生产环境代码
- `develop`: 开发环境代码
- `feature/*`: 功能分支
- `hotfix/*`: 紧急修复分支

---

## 📞 联系方式

- **项目负责人**: [待填写]
- **技术负责人**: [待填写]
- **文档维护**: [待填写]

---

## 📅 更新日志

### v1.0 (2025-01-XX)

- ✅ 完成架构拆分方案设计
- ✅ 完成 API 接口设计
- ✅ 完成数据库设计
- ✅ 完成项目结构规划
- ✅ 创建架构文档总览

---

## 🎯 下一步行动

1. **评审架构方案**
   - 团队评审架构设计
   - 确认技术栈选型
   - 评估实施难度

2. **准备开发环境**
   - 搭建后端开发环境
   - 配置数据库和缓存
   - 准备测试数据

3. **开始实施**
   - 按照拆分步骤逐步实施
   - 定期同步进度
   - 及时调整方案

---

## 📝 更新日志

### 2026-01-13
- ⏸️ 移动端开发标记为搁置
  - 将移动端开发状态标记为搁置
  - 明确说明暂时不需要开发，未来很长一段时间内不会需要
  - 已编写的代码保留在代码库中

---

**文档版本**: v1.1  
**最后更新**: 2026-01-13  
**维护者**: 开发团队
