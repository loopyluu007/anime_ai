# AI漫导 架构拆分方案

> **目标**: 将现有 Flutter 单体应用拆分为三大低耦合模块  
> **版本**: v1.0  
> **日期**: 2026-01-12

---

## 📋 目录

1. [架构概述](#架构概述)
2. [模块划分](#模块划分)
3. [技术栈选型](#技术栈选型)
4. [API 接口设计](#api-接口设计)
5. [数据模型设计](#数据模型设计)
6. [通信协议](#通信协议)
7. [部署架构](#部署架构)
8. [拆分步骤](#拆分步骤)
9. [迁移策略](#迁移策略)

---

## 🏗️ 架构概述

### 当前架构（单体应用）

```
┌─────────────────────────────────────────┐
│         Flutter 移动端应用                │
├─────────────────────────────────────────┤
│  UI层 (Screens/Widgets)                 │
│  ├── 聊天界面                            │
│  ├── 剧本预览                            │
│  └── 设置页面                            │
├─────────────────────────────────────────┤
│  业务逻辑层 (Controllers/Providers)      │
│  ├── Agent 控制器                        │
│  ├── 剧本控制器                          │
│  └── 状态管理                            │
├─────────────────────────────────────────┤
│  服务层 (Services)                      │
│  ├── API 服务 (直接调用第三方API)        │
│  └── 缓存服务                            │
├─────────────────────────────────────────┤
│  数据层 (Models/Storage)                 │
│  ├── 数据模型                            │
│  └── Hive 本地存储                       │
└─────────────────────────────────────────┘
         ↓ 直接调用
┌─────────────────────────────────────────┐
│      第三方 API (GLM/Tuzi/Gemini)        │
└─────────────────────────────────────────┘
```

**问题:**
- API Key 暴露在前端
- 业务逻辑与 UI 耦合
- Web 端适配困难
- 复杂功能难以跨平台
- 无法统一管理用户数据

### 目标架构（微服务架构）

```
┌─────────────────┐         ┌─────────────────┐
│   移动 App 端    │         │   响应式 Web 端   │
│  (Flutter)      │         │  (Flutter Web)   │
├─────────────────┤         ├─────────────────┤
│  UI 层          │         │  UI 层          │
│  业务逻辑层      │         │  业务逻辑层      │
│  状态管理        │         │  状态管理        │
└────────┬────────┘         └────────┬────────┘
         │                           │
         │      HTTP/WebSocket       │
         └───────────┬───────────────┘
                     │
         ┌───────────▼───────────┐
         │    API Gateway        │
         │  (统一入口/认证/限流)  │
         └───────────┬───────────┘
                     │
    ┌────────────────┼────────────────┐
    │                │                │
┌───▼────┐    ┌──────▼──────┐   ┌────▼─────┐
│ 业务服务 │    │  媒体服务    │   │ 数据服务  │
│ Service │    │  Service   │   │ Service  │
├────────┤    ├────────────┤   ├──────────┤
│ Agent  │    │ 图片生成    │   │ 用户数据  │
│ 剧本生成 │    │ 视频生成    │   │ 对话历史  │
│ 对话管理 │    │ 任务管理  │
│ 任务调度 │    │ 文件存储    │   │ 统计分析  │
└───┬────┘    └──────┬──────┘   └────┬─────┘
    │                │                │
    └────────────────┼────────────────┘
                     │
         ┌───────────▼───────────┐
         │    第三方 API 代理      │
         │  (GLM/Tuzi/Gemini)     │
         └────────────────────────┘
```

**优势:**
- ✅ API Key 安全存储在服务端
- ✅ 前后端分离，职责清晰
- ✅ 移动端和 Web 端共享同一套 API
- ✅ 复杂业务逻辑在服务端统一处理
- ✅ 易于扩展和维护
- ✅ 支持多端数据同步

---

## 📦 模块划分

### 1. 服务器后端 (Backend Service)

#### 1.1 核心职责
- **API 网关**: 统一入口、认证、限流、路由
- **业务服务**: Agent 编排、剧本生成、对话管理
- **媒体服务**: 图片生成、视频生成、文件存储
- **数据服务**: 用户数据、对话历史、任务管理、统计分析

#### 1.2 模块结构
```
backend/
├── api-gateway/          # API 网关
│   ├── auth/            # 认证授权
│   ├── rate-limit/      # 限流
│   └── routing/         # 路由
├── services/
│   ├── agent-service/   # Agent 业务服务
│   │   ├── glm-client/  # GLM API 客户端
│   │   ├── script/      # 剧本生成
│   │   └── conversation/ # 对话管理
│   ├── media-service/   # 媒体服务
│   │   ├── image/       # 图片生成
│   │   ├── video/       # 视频生成
│   │   └── storage/     # 文件存储
│   └── data-service/    # 数据服务
│       ├── user/        # 用户数据
│       ├── conversation/ # 对话历史
│       ├── task/         # 任务管理
│       └── analytics/   # 统计分析
├── shared/              # 共享模块
│   ├── models/          # 数据模型
│   ├── utils/           # 工具类
│   └── config/          # 配置
└── infrastructure/      # 基础设施
    ├── database/        # 数据库
    ├── cache/           # 缓存
    └── queue/           # 消息队列
```

#### 1.3 技术栈建议
- **语言**: Python (FastAPI) 或 Node.js (NestJS) 或 Go (Gin)
- **数据库**: PostgreSQL (主数据库) + Redis (缓存)
- **消息队列**: RabbitMQ 或 Redis Streams
- **文件存储**: MinIO 或 AWS S3 或 阿里云 OSS
- **视频处理**: FFmpeg (服务端)
- **API 文档**: OpenAPI/Swagger

### 2. 移动 App 端 (Mobile App)

#### 2.1 核心职责
- **UI 展示**: 聊天界面、剧本预览、设置页面
- **用户交互**: 输入处理、手势操作、离线缓存
- **状态管理**: 本地状态、API 调用、数据同步
- **平台特性**: 推送通知、相机访问、文件下载

#### 2.2 模块结构
```
mobile-app/
├── lib/
│   ├── main.dart                    # 入口
│   ├── core/                        # 核心模块
│   │   ├── api/                     # API 客户端
│   │   ├── storage/                 # 本地存储
│   │   ├── cache/                   # 缓存管理
│   │   └── config/                  # 配置
│   ├── features/                    # 功能模块
│   │   ├── chat/                    # 聊天功能
│   │   │   ├── screens/            # 界面
│   │   │   ├── widgets/            # 组件
│   │   │   ├── providers/          # 状态管理
│   │   │   └── models/             # 数据模型
│   │   ├── screenplay/             # 剧本功能
│   │   ├── settings/                # 设置功能
│   │   └── gallery/                 # 图库功能
│   ├── shared/                      # 共享模块
│   │   ├── widgets/                # 通用组件
│   │   ├── utils/                  # 工具类
│   │   └── themes/                 # 主题
│   └── platform/                   # 平台特定
│       ├── android/                 # Android 特定
│       └── ios/                     # iOS 特定
└── android/ios/                     # 原生配置
```

#### 2.3 技术栈
- **框架**: Flutter 3.0+
- **状态管理**: Provider 或 Riverpod
- **网络**: Dio
- **本地存储**: Hive (轻量数据) + SharedPreferences (配置)
- **缓存**: flutter_cache_manager
- **视频播放**: video_player + chewie

### 3. 响应式 Web 端 (Web App)

#### 3.1 核心职责
- **响应式 UI**: 适配桌面、平板、移动浏览器
- **用户交互**: 键盘操作、鼠标交互、触摸支持
- **状态管理**: 与移动端共享业务逻辑
- **Web 特性**: PWA、SEO、分享功能

#### 3.2 模块结构
```
web-app/
├── lib/
│   ├── main.dart                    # 入口
│   ├── core/                        # 核心模块（与移动端共享）
│   │   ├── api/                     # API 客户端（共享）
│   │   ├── storage/                 # Web 存储适配
│   │   └── config/                  # 配置
│   ├── features/                    # 功能模块（与移动端共享）
│   │   ├── chat/                    # 聊天功能
│   │   ├── screenplay/             # 剧本功能
│   │   └── settings/                # 设置功能
│   ├── shared/                      # 共享模块（与移动端共享）
│   │   ├── widgets/                # 通用组件
│   │   └── utils/                  # 工具类
│   └── web/                         # Web 特定
│       ├── adapters/               # Web 适配器
│       │   ├── storage_adapter.dart
│       │   ├── video_adapter.dart
│       │   └── file_adapter.dart
│       └── utils/                  # Web 工具
├── web/                             # Web 资源
│   ├── index.html
│   ├── manifest.json
│   └── assets/
└── build/                           # 构建输出
```

#### 3.3 技术栈
- **框架**: Flutter Web 3.0+
- **状态管理**: Provider 或 Riverpod（与移动端共享）
- **网络**: Dio（与移动端共享）
- **本地存储**: IndexedDB (Hive Web) + localStorage
- **视频播放**: video_player_web
- **PWA**: workbox

---

## 🛠️ 技术栈选型

### 后端技术栈对比

| 技术 | Python (FastAPI) | Node.js (NestJS) | Go (Gin) |
|------|------------------|------------------|----------|
| **优势** | 生态丰富、AI 库多 | JavaScript 统一栈 | 性能高、并发好 |
| **适用场景** | AI 集成、数据处理 | 快速开发、全栈 | 高并发、微服务 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

**推荐**: Python (FastAPI)
- AI 模型集成方便（已有 GLM、Gemini 等 Python SDK）
- 视频处理库丰富（FFmpeg-python、opencv-python）
- 开发效率高
- 社区支持好

### 数据库选型

| 数据库 | 用途 | 推荐 |
|--------|------|------|
| **PostgreSQL** | 主数据库（用户、对话、任务） | ✅ |
| **Redis** | 缓存、会话、任务队列 | ✅ |
| **MongoDB** | 可选（非结构化数据） | ⚠️ |

### 文件存储选型

| 存储 | 特点 | 推荐 |
|------|------|------|
| **MinIO** | 开源、S3 兼容 | ✅ 开发环境 |
| **AWS S3** | 云服务、稳定 | ✅ 生产环境 |
| **阿里云 OSS** | 国内访问快 | ✅ 国内部署 |

---

## 🔌 API 接口设计

### API 设计原则

1. **RESTful 风格**: 使用标准 HTTP 方法
2. **统一响应格式**: 所有接口返回统一结构
3. **版本控制**: `/api/v1/` 前缀
4. **认证机制**: JWT Token
5. **错误处理**: 统一错误码和消息
6. **分页**: 列表接口支持分页
7. **WebSocket**: 实时功能（任务进度、消息推送）

### 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2025-01-XX 12:00:00"
}
```

### 错误响应格式

```json
{
  "code": 400,
  "message": "参数错误",
  "error": {
    "field": "prompt",
    "reason": "不能为空"
  },
  "timestamp": "2025-01-XX 12:00:00"
}
```

### 核心 API 接口

#### 1. 认证相关

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户注册 | POST | `/api/v1/auth/register` | 注册新用户 |
| 用户登录 | POST | `/api/v1/auth/login` | 登录获取 Token |
| 刷新 Token | POST | `/api/v1/auth/refresh` | 刷新访问令牌 |
| 用户信息 | GET | `/api/v1/auth/me` | 获取当前用户信息 |

#### 2. 对话相关

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建对话 | POST | `/api/v1/conversations` | 创建新对话 |
| 获取对话列表 | GET | `/api/v1/conversations` | 获取用户所有对话 |
| 获取对话详情 | GET | `/api/v1/conversations/{id}` | 获取单个对话 |
| 更新对话 | PUT | `/api/v1/conversations/{id}` | 更新对话信息 |
| 删除对话 | DELETE | `/api/v1/conversations/{id}` | 删除对话 |
| 获取消息列表 | GET | `/api/v1/conversations/{id}/messages` | 获取对话消息 |

#### 3. 任务相关

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建任务 | POST | `/api/v1/tasks` | 创建新任务（生成剧本） |
| 获取任务列表 | GET | `/api/v1/tasks` | 获取用户任务列表 |
| 获取任务详情 | GET | `/api/v1/tasks/{id}` | 获取任务详情 |
| 获取任务进度 | GET | `/api/v1/tasks/{id}/progress` | 获取任务执行进度 |
| 取消任务 | POST | `/api/v1/tasks/{id}/cancel` | 取消进行中的任务 |
| 删除任务 | DELETE | `/api/v1/tasks/{id}` | 删除任务 |

#### 4. 剧本相关

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 生成剧本草稿 | POST | `/api/v1/screenplays/draft` | 生成剧本草稿 |
| 确认剧本 | POST | `/api/v1/screenplays/{id}/confirm` | 确认剧本开始生成 |
| 获取剧本详情 | GET | `/api/v1/screenplays/{id}` | 获取剧本详情 |
| 更新剧本 | PUT | `/api/v1/screenplays/{id}` | 更新剧本信息 |

#### 5. 媒体相关

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 上传图片 | POST | `/api/v1/media/images/upload` | 上传参考图片 |
| 生成图片 | POST | `/api/v1/media/images/generate` | 生成图片（异步） |
| 获取图片 | GET | `/api/v1/media/images/{id}` | 获取生成的图片 |
| 生成视频 | POST | `/api/v1/media/videos/generate` | 生成视频（异步） |
| 获取视频 | GET | `/api/v1/media/videos/{id}` | 获取生成的视频 |

#### 6. WebSocket 接口

| 事件 | 方向 | 说明 |
|------|------|------|
| `task.progress` | 服务端 → 客户端 | 任务进度更新 |
| `task.completed` | 服务端 → 客户端 | 任务完成通知 |
| `task.failed` | 服务端 → 客户端 | 任务失败通知 |
| `message.new` | 服务端 → 客户端 | 新消息通知 |

### API 接口详细设计文档

详见: `docs/API接口设计文档.md` (待创建)

---

## 📊 数据模型设计

### 核心数据模型

#### 1. 用户模型 (User)

```typescript
interface User {
  id: string;                    // 用户 ID
  username: string;              // 用户名
  email: string;                 // 邮箱
  avatar?: string;               // 头像 URL
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
}
```

#### 2. 对话模型 (Conversation)

```typescript
interface Conversation {
  id: string;                    // 对话 ID
  userId: string;                // 用户 ID
  title: string;                 // 对话标题
  previewText?: string;          // 预览文本
  messageCount: number;          // 消息数量
  isPinned: boolean;            // 是否置顶
  lastAccessedAt: string;        // 最后访问时间
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
}
```

#### 3. 消息模型 (Message)

```typescript
interface Message {
  id: string;                    // 消息 ID
  conversationId: string;        // 对话 ID
  role: 'user' | 'assistant';   // 角色
  content: string;               // 内容（Markdown）
  type: 'text' | 'image' | 'video' | 'screenplay'; // 消息类型
  metadata?: {                    // 元数据
    imageUrl?: string;
    videoUrl?: string;
    screenplayId?: string;
  };
  createdAt: string;             // 创建时间
}
```

#### 4. 任务模型 (Task)

```typescript
interface Task {
  id: string;                    // 任务 ID
  userId: string;                // 用户 ID
  conversationId?: string;       // 关联对话 ID
  type: 'screenplay' | 'image' | 'video'; // 任务类型
  status: 'pending' | 'processing' | 'completed' | 'failed'; // 状态
  progress: number;              // 进度 0-100
  result?: any;                  // 结果数据
  error?: string;                 // 错误信息
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
}
```

#### 5. 剧本模型 (Screenplay)

```typescript
interface Screenplay {
  id: string;                    // 剧本 ID
  taskId: string;                // 任务 ID
  userId: string;                // 用户 ID
  title: string;                  // 剧本标题
  status: 'draft' | 'confirmed' | 'generating' | 'completed'; // 状态
  scenes: Scene[];               // 场景列表
  characterSheets?: CharacterSheet[]; // 角色设定卡
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
}

interface Scene {
  sceneId: number;               // 场景 ID
  narration: string;             // 旁白
  imagePrompt: string;           // 图片提示词
  videoPrompt: string;           // 视频提示词
  imageUrl?: string;             // 图片 URL
  videoUrl?: string;             // 视频 URL
  status: 'pending' | 'generating' | 'completed' | 'failed'; // 状态
}

interface CharacterSheet {
  id: string;                    // 角色 ID
  name: string;                  // 角色名称
  description: string;           // 角色描述
  combinedViewUrl: string;        // 三视图 URL
  frontViewUrl?: string;          // 正面图 URL
  sideViewUrl?: string;           // 侧面图 URL
  backViewUrl?: string;           // 背面图 URL
}
```

### 数据库设计

详见: `docs/数据库设计文档.md` (待创建)

---

## 🔄 通信协议

### HTTP API

- **协议**: HTTPS
- **格式**: JSON
- **认证**: JWT Bearer Token
- **编码**: UTF-8

### WebSocket

- **协议**: WSS (WebSocket Secure)
- **格式**: JSON
- **认证**: 连接时传递 JWT Token
- **心跳**: 30 秒间隔

### 文件上传

- **协议**: HTTPS
- **格式**: multipart/form-data
- **限制**: 单文件最大 50MB

---

## 🚀 部署架构

### 开发环境

```
┌─────────────┐
│  开发机器    │
├─────────────┤
│ 后端服务     │  (localhost:8000)
│ 移动端调试   │  (Flutter Dev)
│ Web 端调试  │  (localhost:8080)
└─────────────┘
```

### 生产环境

```
                    ┌──────────────┐
                    │   CDN/OSS    │
                    │  (静态资源)   │
                    └──────┬───────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐
    │ 移动 App │      │  Web App  │     │ API Gateway│
    │  (发布)  │      │  (Nginx)  │     │  (Nginx)  │
    └─────────┘      └───────────┘     └─────┬─────┘
                                              │
                    ┌─────────────────────────┼─────────────┐
                    │                         │             │
            ┌───────▼──────┐        ┌─────────▼────┐  ┌────▼────┐
            │  业务服务     │        │  媒体服务     │  │ 数据服务 │
            │  (Docker)    │        │  (Docker)    │  │ (Docker)│
            └───────┬──────┘        └─────────┬────┘  └────┬────┘
                    │                         │             │
                    └─────────────────────────┼─────────────┘
                                              │
                    ┌─────────────────────────▼─────────────┐
                    │        PostgreSQL + Redis             │
                    │        MinIO/S3 (文件存储)            │
                    └────────────────────────────────────────┘
```

### 容器化部署

- **后端服务**: Docker + Docker Compose
- **数据库**: PostgreSQL (Docker)
- **缓存**: Redis (Docker)
- **文件存储**: MinIO (Docker) 或云存储

---

## 📝 拆分步骤

### 阶段一：后端服务搭建（2-3 周）

#### Week 1: 基础架构
- [ ] 搭建后端项目框架（FastAPI/NestJS）
- [ ] 配置数据库（PostgreSQL + Redis）
- [ ] 实现认证授权（JWT）
- [ ] 配置 API 网关
- [ ] 编写 API 文档（OpenAPI）

#### Week 2: 核心服务
- [ ] 实现用户服务
- [ ] 实现对话服务
- [ ] 实现任务服务
- [ ] 实现 GLM API 代理
- [ ] 实现图片生成服务

#### Week 3: 媒体服务
- [ ] 实现视频生成服务
- [ ] 实现文件存储服务
- [✅] 实现 WebSocket 实时推送

### 阶段二：移动端重构（2-3 周）⏸️ 已搁置

> **状态说明**: 移动端开发已标记为搁置，暂时不需要开发，未来很长一段时间内不会需要。但已编写的代码将保留在代码库中。

#### Week 1: API 客户端
- [⏸️] ~~创建 API 客户端封装~~（开发已搁置）
- [⏸️] ~~实现认证流程~~（开发已搁置）
- [⏸️] ~~实现数据模型映射~~（开发已搁置）
- [⏸️] ~~实现错误处理~~（开发已搁置）

#### Week 2: 功能迁移
- [⏸️] ~~迁移对话功能~~（开发已搁置）
- [⏸️] ~~迁移剧本功能~~（开发已搁置）
- [⏸️] ~~迁移设置功能~~（开发已搁置）
- [⏸️] ~~移除直接 API 调用~~（开发已搁置）

#### Week 3: 优化测试
- [⏸️] ~~优化离线缓存~~（开发已搁置）
- [⏸️] ~~实现数据同步~~（开发已搁置）
- [⏸️] ~~完善错误处理~~（开发已搁置）
- [⏸️] ~~全面测试~~（开发已搁置）

### 阶段三：Web 端开发（2-3 周）

#### Week 1: 基础搭建
- [ ] 创建 Web 项目
- [ ] 配置 Web 适配器
- [ ] 实现响应式布局
- [ ] 配置 PWA

#### Week 2: 功能实现
- [ ] 复用移动端业务逻辑（移动端代码已保留，可参考）
- [ ] 实现 Web 特定功能
- [ ] 优化视频播放
- [ ] 实现文件上传

#### Week 3: 优化发布
- [ ] 性能优化
- [ ] SEO 优化
- [ ] 浏览器兼容性测试
- [ ] 部署上线

### 阶段四：集成测试（1 周）

- [ ] 端到端测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 用户体验测试

---

## 🔄 迁移策略

### 策略一：渐进式迁移（推荐）

1. **第一步**: 搭建后端服务，实现 API 代理
2. **第二步**: ~~移动端逐步切换 API 调用~~（移动端已搁置）
3. **第三步**: 开发 Web 端，复用 API
4. **第四步**: 移除前端直接 API 调用（Web端）

### 策略二：并行开发

1. **后端**: 独立开发，提供 Mock 数据
2. **移动端**: ~~同时重构，对接 Mock API~~（移动端已搁置）
3. **Web 端**: 同时开发，对接 Mock API
4. **集成**: 统一切换到真实后端（Web端）

### 数据迁移

- **用户数据**: 首次登录时创建后端账户
- **对话历史**: 导出导入功能
- **本地缓存**: 逐步同步到服务端

---

## 📚 相关文档

- [API 接口设计文档](./API接口设计文档.md) (待创建)
- [数据库设计文档](./数据库设计文档.md) (待创建)
- [部署运维文档](./部署运维文档.md) (待创建)
- [开发规范文档](./开发规范文档.md) (待创建)

---

## 📝 更新日志

### 2026-01-13
- ⏸️ 移动端开发标记为搁置
  - 将移动端开发状态标记为搁置
  - 明确说明暂时不需要开发，未来很长一段时间内不会需要
  - 已编写的代码保留在代码库中

---

**文档版本**: v1.1  
**最后更新**: 2026-01-13  
**维护者**: 开发团队
