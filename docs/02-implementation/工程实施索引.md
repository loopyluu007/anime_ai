# AI漫导 工程实施总览

> **目标**: 后端服务和 Web 端详细工程实施方案  
> **版本**: v1.0  
> **日期**: 2026-01-12

---

## 📚 文档索引

### 核心工程文档

1. **[后端工程实施方案](./后端工程实施方案.md)** ⭐
   - 项目初始化
   - 目录结构
   - 核心模块实现
   - API 实现
   - 第三方 API 集成
   - WebSocket 实现
   - 部署配置

2. **[Web端工程实施方案](./Web端工程实施方案.md)** ⭐
   - 项目初始化
   - Web 适配层
   - API 客户端实现
   - 功能模块实现
   - 响应式布局
   - PWA 配置
   - 构建和部署

3. **[API接口设计文档](../03-api-database/API接口设计文档.md)**
   - RESTful API 设计
   - WebSocket 实时通信
   - 请求/响应格式

4. **[数据库设计文档](../03-api-database/数据库设计文档.md)**
   - 表结构设计
   - 索引设计
   - 关系图

---

## 🎯 实施目标

### 后端服务

- ✅ 提供统一的 RESTful API
- ✅ 实现 JWT 认证授权
- ✅ 集成 GLM、Tuzi、Gemini 等第三方 API
- ✅ 实现 WebSocket 实时推送
- ✅ 支持复杂业务逻辑
- ✅ 使用 PostgreSQL + Redis 存储数据

### Web 端

- ✅ 适配 Flutter Web 平台
- ✅ 实现响应式布局（桌面/平板/移动）
- ✅ 配置 PWA 支持
- ✅ 复用移动端业务逻辑
- ✅ 实现 Web 特定功能（文件上传、视频播放等）

---

## 🏗️ 技术栈

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Python** | 3.11+ | 编程语言 |
| **FastAPI** | 0.104+ | Web 框架 |
| **SQLAlchemy** | 2.0+ | ORM |
| **PostgreSQL** | 15+ | 主数据库 |
| **Redis** | 7+ | 缓存和队列 |
| **Docker** | - | 容器化部署 |

### Web 端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Flutter** | 3.0+ | UI 框架 |
| **Dart** | 3.0+ | 编程语言 |
| **Provider** | 6.1+ | 状态管理 |
| **Dio** | 5.4+ | HTTP 客户端 |
| **Hive** | 2.2+ | 本地存储（IndexedDB） |

---

## 📦 项目结构

### 后端项目结构

```
backend/
├── api-gateway/          # API 网关
├── services/             # 业务服务
│   ├── agent-service/   # Agent 业务服务
│   ├── media-service/   # 媒体服务
│   └── data-service/    # 数据服务
├── shared/               # 共享模块
└── infrastructure/       # 基础设施
```

### Web 端项目结构

```
web-app/
├── lib/
│   ├── core/            # 核心模块
│   ├── features/        # 功能模块
│   ├── shared/          # 共享模块
│   └── web/             # Web 特定代码
└── web/                 # Web 资源
```

---

## 🔌 API 接口

### 基础路径

- **HTTP API**: `https://api.directorai.com/api/v1`
- **WebSocket**: `wss://api.directorai.com/ws`

### 核心接口

| 模块 | 接口 | 说明 |
|------|------|------|
| **认证** | `POST /auth/login` | 用户登录 |
| **认证** | `POST /auth/register` | 用户注册 |
| **对话** | `GET /conversations` | 获取对话列表 |
| **对话** | `POST /conversations` | 创建对话 |
| **任务** | `POST /tasks` | 创建任务 |
| **任务** | `GET /tasks/{id}/progress` | 获取任务进度 |
| **剧本** | `POST /screenplays/draft` | 生成剧本草稿 |
| **媒体** | `POST /media/images/generate` | 生成图片 |
| **媒体** | `POST /media/videos/generate` | 生成视频 |

**详细文档**: [API接口设计文档](../03-api-database/API接口设计文档.md)

---

## 🗄️ 数据库

### 核心表

- `users` - 用户表
- `conversations` - 对话表
- `messages` - 消息表
- `tasks` - 任务表
- `screenplays` - 剧本表
- `scenes` - 场景表
- `character_sheets` - 角色设定表
- `media_files` - 媒体文件表

**详细文档**: [数据库设计文档](../03-api-database/数据库设计文档.md)

---

## 🚀 实施计划

### 后端服务（4周）✅ 已完成

#### Week 1: 项目初始化 ✅
- [✅] 创建项目结构
- [✅] 配置开发环境
- [✅] 实现共享模块
- [✅] 配置数据库

#### Week 2: 核心服务 ✅
- [✅] 实现认证服务
- [✅] 实现对话服务
- [✅] 实现任务服务
- [✅] 实现 GLM 客户端

#### Week 3: 媒体服务 ✅
- [✅] 实现图片生成服务
- [✅] 实现视频生成服务
- [✅] 实现文件存储服务

#### Week 4: 集成和部署 ✅
- [✅] 实现 WebSocket
- [✅] 测试框架搭建（2026-01-13）
- [✅] 认证服务测试完成（9个单元测试 + 10个集成测试）
- [⏳] 其他服务API集成测试（待补充）
- [✅] Docker 配置
- [✅] 部署配置（待上线）

### Web 端（6周）✅ 基本完成

#### Week 1: 项目初始化 ✅
- [✅] 创建 Web 项目
- [✅] 配置依赖
- [✅] 创建目录结构

#### Week 2: Web 适配层 ✅
- [✅] 实现存储适配器
- [✅] 实现视频适配器
- [✅] 实现文件适配器

#### Week 3: API 客户端 ✅
- [✅] 实现 API 客户端基类
- [✅] 实现各功能客户端

#### Week 4: 功能模块 ✅
- [✅] 实现认证功能
- [✅] 实现聊天功能
- [✅] 实现剧本功能

#### Week 5: 响应式和优化 ✅
- [✅] 实现响应式布局
- [⏳] 配置 PWA（图标待创建）
- [⏳] 性能优化（待完善）

#### Week 6: 测试和部署 ⏳
- [⏳] 功能测试（待补充）
- [⏳] 浏览器兼容性测试（待补充）
- [⏳] 构建和部署（待上线）

---

## 🔧 开发环境

### 后端开发环境

```bash
# 1. 安装 Python 3.11+
python --version

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，配置数据库和 API Key

# 5. 运行数据库迁移
python scripts/migrate.py

# 6. 启动服务
uvicorn main:app --reload --port 8000
```

### Web 端开发环境

```bash
# 1. 安装 Flutter 3.0+
flutter --version

# 2. 启用 Web 支持
flutter config --enable-web

# 3. 安装依赖
flutter pub get

# 4. 运行 Web 应用
flutter run -d chrome
```

---

## 📝 关键实施要点

### 后端关键点

1. **认证机制**
   - 使用 JWT Token
   - Token 存储在 Redis
   - 实现 Token 刷新机制

2. **异步任务处理**
   - 使用后台任务处理耗时操作
   - WebSocket 推送任务进度
   - 任务状态持久化

3. **第三方 API 集成**
   - GLM API（剧本生成）
   - Tuzi API（视频生成）
   - Gemini API（图片生成）
   - 实现重试机制和错误处理

4. **文件存储**
   - 使用 MinIO（开发）或 S3（生产）
   - 实现文件上传和下载
   - 文件 URL 生成和管理

### Web 端关键点

1. **平台适配**
   - 使用条件导入分离平台代码
   - Web 端使用 IndexedDB 存储
   - Web 端视频播放使用 HTML5 video

2. **API 调用**
   - 统一使用 API 客户端
   - 实现 Token 自动刷新
   - 错误处理和重试机制

3. **响应式设计**
   - 使用 MediaQuery 检测屏幕大小
   - 实现断点布局
   - 适配桌面/平板/移动

4. **性能优化**
   - 代码分割和懒加载
   - 图片懒加载和压缩
   - 缓存策略优化

---

## 🧪 测试策略

### 后端测试

- **单元测试**: pytest
- **集成测试**: API 接口测试
- **E2E 测试**: 完整流程测试

### Web 端测试

- **单元测试**: Flutter test
- **Widget 测试**: 组件测试
- **集成测试**: 功能流程测试
- **浏览器兼容性**: Chrome、Firefox、Safari

---

## 🐛 常见问题

### 后端常见问题

1. **数据库连接失败**
   - 检查 DATABASE_URL 配置
   - 确认 PostgreSQL 服务运行
   - 检查网络连接

2. **第三方 API 调用失败**
   - 检查 API Key 配置
   - 检查网络连接
   - 查看错误日志

3. **WebSocket 连接失败**
   - 检查 Token 是否有效
   - 检查 WebSocket URL
   - 查看服务器日志

### Web 端常见问题

1. **CORS 错误**
   - 后端需要配置 CORS
   - 检查 API 基础 URL
   - 检查请求头

2. **视频无法播放**
   - 检查视频格式（MP4 H.264）
   - 检查视频 URL 是否可访问
   - 检查 CORS 配置

3. **存储失败**
   - 检查浏览器 IndexedDB 支持
   - 检查存储配额
   - 查看浏览器控制台错误

---

## 📚 参考资源

### 官方文档

- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [Flutter Web 文档](https://docs.flutter.dev/platform-integration/web)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Redis 文档](https://redis.io/docs/)

### 项目文档

- [架构拆分方案](../01-architecture/架构拆分方案.md)
- [API接口设计文档](../03-api-database/API接口设计文档.md)
- [数据库设计文档](../03-api-database/数据库设计文档.md)
- [项目结构规划](../01-architecture/项目结构规划.md)

---

## 🎯 下一步行动

### 立即开始

1. **阅读详细文档**
   - [后端工程实施方案](./后端工程实施方案.md)
   - [Web端工程实施方案](./Web端工程实施方案.md)

2. **准备开发环境**
   - 安装 Python 3.11+
   - 安装 Flutter 3.0+
   - 安装 PostgreSQL 和 Redis

3. **开始实施**
   - 按照实施步骤逐步进行
   - 遇到问题查阅文档
   - 及时记录和解决问题

---

## 📞 支持

- **文档问题**: 查看相关文档
- **技术问题**: 查阅官方文档
- **实施问题**: 参考实施步骤

---

**文档版本**: v1.0  
**最后更新**: 2026-01-13  
**维护者**: 开发团队
