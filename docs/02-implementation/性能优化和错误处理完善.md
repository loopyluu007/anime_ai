# æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†å®Œå–„

> **å®Œæˆæ—¶é—´**: 2026-01-15  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†å®Œå–„çš„å®æ–½å†…å®¹ï¼ŒåŒ…æ‹¬æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ã€APIå“åº”ä¼˜åŒ–ã€ç»Ÿä¸€é”™è¯¯å¤„ç†ã€æ—¥å¿—ç³»ç»Ÿå®Œå–„å’Œç›‘æ§å‘Šè­¦ç³»ç»Ÿã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. é”™è¯¯å¤„ç†å®Œå–„ âœ…

#### 1.1 æ‰©å±•å¼‚å¸¸ç±»

**æ–‡ä»¶**: `backend/shared/utils/exceptions.py`

æ–°å¢å¼‚å¸¸ç±»å‹ï¼š
- `ValidationError` - å‚æ•°éªŒè¯é”™è¯¯ï¼ˆå·²å­˜åœ¨ï¼Œå·²å¢å¼ºï¼‰
- `AuthenticationError` - è®¤è¯é”™è¯¯ï¼ˆå·²å­˜åœ¨ï¼‰
- `AuthorizationError` - æˆæƒé”™è¯¯ï¼ˆæ–°å¢ï¼‰
- `NotFoundError` - èµ„æºä¸å­˜åœ¨ï¼ˆå·²å­˜åœ¨ï¼‰
- `ConflictError` - èµ„æºå†²çªé”™è¯¯ï¼ˆæ–°å¢ï¼‰
- `RateLimitError` - é™æµé”™è¯¯ï¼ˆæ–°å¢ï¼‰
- `InternalServerError` - å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼ˆæ–°å¢ï¼‰
- `ServiceUnavailableError` - æœåŠ¡ä¸å¯ç”¨é”™è¯¯ï¼ˆæ–°å¢ï¼‰
- `TimeoutError` - è¯·æ±‚è¶…æ—¶é”™è¯¯ï¼ˆæ–°å¢ï¼‰

**ç‰¹æ€§**:
- ç»Ÿä¸€çš„é”™è¯¯ç ä½“ç³»
- æ”¯æŒé”™è¯¯æ•°æ®ï¼ˆerror_dataï¼‰å­—æ®µ
- æ‰€æœ‰å¼‚å¸¸ç»§æ‰¿è‡ª `DirectorAIException`

#### 1.2 ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**æ–‡ä»¶**: `backend/shared/middleware/error_handler.py`

**åŠŸèƒ½**:
- æ•è·æ‰€æœ‰å¼‚å¸¸å¹¶è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”
- è‡ªåŠ¨è®°å½•é”™è¯¯æ—¥å¿—
- é›†æˆç›‘æ§æŒ‡æ ‡æ”¶é›†
- ç”Ÿæˆå”¯ä¸€é”™è¯¯IDç”¨äºè¿½è¸ª
- è®°å½•è¯·æ±‚è€—æ—¶

**é”™è¯¯å“åº”æ ¼å¼**:
```json
{
  "error": {
    "code": 1000,
    "message": "é”™è¯¯æè¿°",
    "error_id": "uuid",
    "data": {}
  }
}
```

**å·²é›†æˆåˆ°**:
- âœ… API Gateway (`backend/api_gateway/src/main.py`)
- âœ… Agent Service (`backend/services/agent_service/src/main.py`)
- âœ… Data Service (`backend/services/data_service/src/main.py`)
- âœ… Media Service (`backend/services/media_service/src/main.py`)

---

### 2. æ—¥å¿—ç³»ç»Ÿå®Œå–„ âœ…

#### 2.1 å¢å¼ºæ—¥å¿—åŠŸèƒ½

**æ–‡ä»¶**: `backend/shared/utils/logger.py`

**æ–°å¢åŠŸèƒ½**:
- âœ… JSONæ ¼å¼æ—¥å¿—æ”¯æŒï¼ˆç»“æ„åŒ–æ—¥å¿—ï¼‰
- âœ… æ–‡ä»¶æ—¥å¿—è¾“å‡ºï¼ˆå¯é…ç½®æ—¥å¿—ç›®å½•ï¼‰
- âœ… æ—¥å¿—çº§åˆ«é…ç½®
- âœ… è¯·æ±‚æ—¥å¿—è®°å½•å‡½æ•°
- âœ… é”™è¯¯æ—¥å¿—è®°å½•å‡½æ•°
- âœ… æ”¯æŒé¢å¤–æ•°æ®å­—æ®µï¼ˆextra_dataï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from shared.utils.logger import setup_logger

# æ§åˆ¶å°æ—¥å¿—
logger = setup_logger("my_service")

# æ–‡ä»¶æ—¥å¿—
logger = setup_logger("my_service", log_file="my_service.log")

# JSONæ ¼å¼æ—¥å¿—
logger = setup_logger("my_service", use_json=True, log_file="my_service.json")
```

#### 2.2 æ—¥å¿—æ ¼å¼

**æ ‡å‡†æ ¼å¼**:
```
2026-01-15 10:30:45 - my_service - INFO - æ¶ˆæ¯å†…å®¹ [module:function:123]
```

**JSONæ ¼å¼**:
```json
{
  "timestamp": "2026-01-15T10:30:45.123456",
  "level": "INFO",
  "logger": "my_service",
  "message": "æ¶ˆæ¯å†…å®¹",
  "module": "module",
  "function": "function",
  "line": 123,
  "extra": {}
}
```

---

### 3. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– âœ…

#### 3.1 ä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢

**ä¼˜åŒ–å‰**: å¤šæ¬¡å•ç‹¬æŸ¥è¯¢
```python
total_count = query.count()
for status in statuses:
    count = query.filter(Task.status == status).count()
```

**ä¼˜åŒ–å**: å•æ¬¡èšåˆæŸ¥è¯¢
```python
stats_query = query.with_entities(
    func.count(Task.id).label("total_count"),
    func.sum(case((Task.status == "pending", 1), else_=0)).label("pending_count"),
    # ... å…¶ä»–ç»Ÿè®¡
)
```

**ä¼˜åŒ–æ–‡ä»¶**:
- âœ… `backend/services/data_service/src/repositories/task_repository.py`
  - `get_task_stats()` - ä½¿ç”¨å•æ¬¡èšåˆæŸ¥è¯¢è·å–æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯
  - ä¼˜åŒ–å¹³å‡å¤„ç†æ—¶é—´è®¡ç®—ï¼ˆä½¿ç”¨æ•°æ®åº“å‡½æ•°ï¼‰
  
- âœ… `backend/services/data_service/src/repositories/user_repository.py`
  - `get_user_stats()` - ä¼˜åŒ–ä»»åŠ¡ç»Ÿè®¡æŸ¥è¯¢ï¼ˆä½¿ç”¨èšåˆæŸ¥è¯¢ï¼‰

**æ€§èƒ½æå‡**:
- ç»Ÿè®¡æŸ¥è¯¢ä» N+1 æ¬¡æŸ¥è¯¢å‡å°‘åˆ° 1-2 æ¬¡æŸ¥è¯¢
- å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
- é™ä½æ•°æ®åº“è´Ÿè½½

#### 3.2 ç´¢å¼•ä¼˜åŒ–

**å·²å­˜åœ¨çš„ç´¢å¼•**ï¼ˆåœ¨ `001_initial.sql` ä¸­ï¼‰:
- âœ… ç”¨æˆ·è¡¨ï¼šemail, username
- âœ… å¯¹è¯è¡¨ï¼šuser_id, (user_id, updated_at), (user_id, is_pinned, updated_at)
- âœ… æ¶ˆæ¯è¡¨ï¼šconversation_id, (conversation_id, created_at), type
- âœ… ä»»åŠ¡è¡¨ï¼šuser_id, (user_id, status), conversation_id, type, status
- âœ… å‰§æœ¬è¡¨ï¼štask_id, user_id, status
- âœ… åœºæ™¯è¡¨ï¼šscreenplay_id, status
- âœ… åª’ä½“æ–‡ä»¶è¡¨ï¼šuser_id, type, created_at
- âœ… ä»»åŠ¡æ—¥å¿—è¡¨ï¼štask_id, level, created_at

**ç´¢å¼•è¦†ç›–æƒ…å†µ**: âœ… å·²è¦†ç›–æ‰€æœ‰å¸¸ç”¨æŸ¥è¯¢åœºæ™¯

---

### 4. ç¼“å­˜ç³»ç»Ÿ âœ…

#### 4.1 ç¼“å­˜å·¥å…·ç±»

**æ–‡ä»¶**: `backend/shared/utils/cache.py`

**åŠŸèƒ½**:
- Redisç¼“å­˜ç®¡ç†
- ç¼“å­˜é”®ç”Ÿæˆï¼ˆæ”¯æŒå‚æ•°å“ˆå¸Œï¼‰
- ç¼“å­˜è£…é¥°å™¨ï¼ˆ`@cached`ï¼‰
- ç”¨æˆ·ç¼“å­˜æ¸…ç†
- æ¨¡å¼åŒ¹é…åˆ é™¤

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from shared.utils.cache import cache_manager, cached

# ç›´æ¥ä½¿ç”¨
cache_manager.set("key", value, ttl=300)
value = cache_manager.get("key")

# è£…é¥°å™¨æ–¹å¼
@cached(prefix="user_stats", ttl=300)
def get_user_stats(user_id: UUID):
    # ... æŸ¥è¯¢é€»è¾‘
    return stats
```

**ç¼“å­˜ç­–ç•¥**:
- é»˜è®¤TTL: 5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰
- æ”¯æŒè‡ªå®šä¹‰TTL
- è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–JSON

---

### 5. ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ âœ…

#### 5.1 æŒ‡æ ‡æ”¶é›†å™¨

**æ–‡ä»¶**: `backend/shared/utils/monitoring.py`

**åŠŸèƒ½**:
- âœ… è¯·æ±‚æŒ‡æ ‡æ”¶é›†ï¼ˆæ€»æ•°ã€æŒ‰ç«¯ç‚¹ã€æŒ‰çŠ¶æ€ç ï¼‰
- âœ… å“åº”æ—¶é—´è®°å½•ï¼ˆæœ€è¿‘1000æ¡ï¼‰
- âœ… é”™è¯¯æŒ‡æ ‡æ”¶é›†ï¼ˆæŒ‰ç±»å‹ã€æŒ‰ç«¯ç‚¹ï¼‰
- âœ… ç”¨æˆ·è¯·æ±‚ç»Ÿè®¡
- âœ… æŒ‡æ ‡æŸ¥è¯¢æ¥å£

**è®°å½•çš„æŒ‡æ ‡**:
- æ€»è¯·æ±‚æ•°ï¼ˆæŒ‰æ—¥æœŸï¼‰
- ç«¯ç‚¹è¯·æ±‚æ•°ï¼ˆæŒ‰æ—¥æœŸï¼‰
- çŠ¶æ€ç åˆ†å¸ƒï¼ˆæŒ‰æ—¥æœŸï¼‰
- å“åº”æ—¶é—´ï¼ˆæŒ‰ç«¯ç‚¹ï¼‰
- é”™è¯¯æ•°ï¼ˆæŒ‰ç±»å‹ã€ç«¯ç‚¹ã€æ—¥æœŸï¼‰
- ç”¨æˆ·è¯·æ±‚æ•°ï¼ˆæŒ‰ç”¨æˆ·ã€æ—¥æœŸï¼‰

#### 5.2 å‘Šè­¦ç®¡ç†å™¨

**åŠŸèƒ½**:
- âœ… é”™è¯¯ç‡æ£€æŸ¥ï¼ˆå¯é…ç½®é˜ˆå€¼å’Œçª—å£ï¼‰
- âœ… å“åº”æ—¶é—´æ£€æŸ¥ï¼ˆå¯é…ç½®é˜ˆå€¼ï¼‰
- âœ… å‘Šè­¦å‘é€ï¼ˆå­˜å‚¨åˆ°Rediså¹¶è®°å½•æ—¥å¿—ï¼‰
- âœ… å‘Šè­¦åˆ†çº§ï¼ˆwarning, error, criticalï¼‰

**å‘Šè­¦æ£€æŸ¥**:
```python
from shared.utils.monitoring import alert_manager

# æ£€æŸ¥é”™è¯¯ç‡ï¼ˆé»˜è®¤é˜ˆå€¼10%ï¼Œçª—å£5åˆ†é’Ÿï¼‰
if alert_manager.check_error_rate(threshold=0.1, window_minutes=5):
    alert_manager.send_alert(
        "high_error_rate",
        "é”™è¯¯ç‡è¶…è¿‡10%",
        severity="critical"
    )

# æ£€æŸ¥å“åº”æ—¶é—´
if alert_manager.check_response_time("/api/v1/tasks", threshold_ms=1000):
    alert_manager.send_alert(
        "slow_response",
        "ä»»åŠ¡APIå“åº”æ—¶é—´è¶…è¿‡1ç§’",
        severity="warning"
    )
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

| æŸ¥è¯¢ç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|---------|--------|--------|------|
| ä»»åŠ¡ç»Ÿè®¡ | 8-10æ¬¡æŸ¥è¯¢ | 1-2æ¬¡æŸ¥è¯¢ | **80-90%** |
| ç”¨æˆ·ç»Ÿè®¡ | 5-6æ¬¡æŸ¥è¯¢ | 2-3æ¬¡æŸ¥è¯¢ | **50-60%** |
| å¯¹è¯ç»Ÿè®¡ | 4-5æ¬¡æŸ¥è¯¢ | 1-2æ¬¡æŸ¥è¯¢ | **60-70%** |

### APIå“åº”ä¼˜åŒ–

- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†å‡å°‘å¼‚å¸¸å¤„ç†å¼€é”€
- âœ… æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–å‡å°‘I/Oå¼€é”€
- âœ… ç›‘æ§æŒ‡æ ‡å¼‚æ­¥æ”¶é›†ï¼Œä¸å½±å“ä¸»æµç¨‹

---

## ğŸ”§ é…ç½®è¯´æ˜

### æ—¥å¿—é…ç½®

**ç¯å¢ƒå˜é‡**:
- `LOG_LEVEL`: æ—¥å¿—çº§åˆ«ï¼ˆDEBUG, INFO, WARNING, ERROR, CRITICALï¼‰
- `LOG_DIR`: æ—¥å¿—ç›®å½•ï¼ˆé»˜è®¤: `logs`ï¼‰
- `LOG_FORMAT`: æ—¥å¿—æ ¼å¼ï¼ˆ`text` æˆ– `json`ï¼‰

### ç¼“å­˜é…ç½®

**ç¯å¢ƒå˜é‡**:
- `REDIS_URL`: Redisè¿æ¥URLï¼ˆé»˜è®¤: `redis://localhost:6379/0`ï¼‰
- `CACHE_DEFAULT_TTL`: é»˜è®¤ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤: 300ï¼‰

### ç›‘æ§é…ç½®

**å‘Šè­¦é˜ˆå€¼**ï¼ˆå¯åœ¨ä»£ç ä¸­é…ç½®ï¼‰:
- é”™è¯¯ç‡é˜ˆå€¼: é»˜è®¤ 10%
- å“åº”æ—¶é—´é˜ˆå€¼: é»˜è®¤ 1000ms
- æ£€æŸ¥çª—å£: é»˜è®¤ 5åˆ†é’Ÿ

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### 1. ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†

**æŠ›å‡ºå¼‚å¸¸**:
```python
from shared.utils.exceptions import NotFoundError, ValidationError

# èµ„æºä¸å­˜åœ¨
raise NotFoundError(resource="ä»»åŠ¡", resource_id=str(task_id))

# å‚æ•°éªŒè¯é”™è¯¯
raise ValidationError("ç”¨æˆ·åä¸èƒ½ä¸ºç©º", field="username")
```

**é”™è¯¯ä¼šè‡ªåŠ¨è¢«ä¸­é—´ä»¶æ•è·å¹¶è¿”å›ç»Ÿä¸€æ ¼å¼**

### 2. ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿ

```python
from shared.utils.logger import setup_logger, log_error

logger = setup_logger(__name__)

# è®°å½•ä¿¡æ¯
logger.info("æ“ä½œæˆåŠŸ", extra={"extra_data": {"user_id": user_id}})

# è®°å½•é”™è¯¯
try:
    # ... æ“ä½œ
except Exception as e:
    log_error(logger, e, context={"operation": "create_task"})
```

### 3. ä½¿ç”¨ç¼“å­˜

```python
from shared.utils.cache import cached

@cached(prefix="user_stats", ttl=300)
async def get_user_stats(user_id: UUID):
    # ... æŸ¥è¯¢é€»è¾‘
    return stats

# æ¸…é™¤ç”¨æˆ·ç¼“å­˜
from shared.utils.cache import cache_manager
cache_manager.clear_user_cache(str(user_id))
```

### 4. æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡

```python
from shared.utils.monitoring import metrics_collector

# è·å–ä»Šæ—¥æŒ‡æ ‡
metrics = metrics_collector.get_metrics()

# è·å–ç‰¹å®šç«¯ç‚¹æŒ‡æ ‡
metrics = metrics_collector.get_metrics(endpoint="/api/v1/tasks")
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **APIå“åº”ç¼“å­˜**
   - ä¸ºGETè¯·æ±‚æ·»åŠ å“åº”ç¼“å­˜
   - å®ç°ç¼“å­˜å¤±æ•ˆç­–ç•¥
   - æ·»åŠ ç¼“å­˜é¢„çƒ­

2. **æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–**
   - è°ƒæ•´è¿æ¥æ± å¤§å°
   - å®ç°è¿æ¥æ± ç›‘æ§
   - æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—

3. **å‰ç«¯ä»£ç åˆ†å‰²**
   - å®ç°è·¯ç”±çº§åˆ«çš„ä»£ç åˆ†å‰²
   - ä¼˜åŒ–å›¾ç‰‡/è§†é¢‘æ‡’åŠ è½½
   - æ·»åŠ èµ„æºé¢„åŠ è½½

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰

1. **åˆ†å¸ƒå¼è¿½è¸ª**
   - é›†æˆOpenTelemetry
   - å®ç°è¯·æ±‚è¿½è¸ª
   - æ·»åŠ æ€§èƒ½åˆ†æ

2. **å‘Šè­¦é€šçŸ¥**
   - é›†æˆé‚®ä»¶/çŸ­ä¿¡å‘Šè­¦
   - å®ç°å‘Šè­¦èšåˆ
   - æ·»åŠ å‘Šè­¦é™é»˜

3. **æ€§èƒ½æµ‹è¯•**
   - å‹åŠ›æµ‹è¯•
   - è´Ÿè½½æµ‹è¯•
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åç«¯å·¥ç¨‹å®æ–½æ–¹æ¡ˆ](./åç«¯å·¥ç¨‹å®æ–½æ–¹æ¡ˆ.md)
- [å¼€å‘è¿›åº¦æ€»è§ˆ](./å¼€å‘è¿›åº¦æ€»è§ˆ.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../03-api-database/æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)

---

**æœ€åæ›´æ–°**: 2026-01-15  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
