# åç«¯å¼€å‘æ–½å·¥æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.3  
> **æœ€åæ›´æ–°**: 2026-01-13ï¼ˆæ™šä¸Šï¼‰  
> **ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [å¼€å‘ç¯å¢ƒé…ç½®](#å¼€å‘ç¯å¢ƒé…ç½®)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
5. [APIå®ç°çŠ¶æ€](#apiå®ç°çŠ¶æ€)
6. [æ•°æ®åº“è¿ç§»](#æ•°æ®åº“è¿ç§»)
7. [Dockeréƒ¨ç½²](#dockeréƒ¨ç½²)
8. [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

AIæ¼«å¯¼åç«¯æœåŠ¡é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼ŒåŸºäºFastAPIæ¡†æ¶å¼€å‘ã€‚ä¸»è¦åŒ…å«ï¼š

- **Agent Service**: å¤„ç†å¯¹è¯ã€ä»»åŠ¡ã€å‰§æœ¬ç­‰æ ¸å¿ƒä¸šåŠ¡
- **Media Service**: å¤„ç†å›¾ç‰‡ã€è§†é¢‘ç”Ÿæˆå’Œåˆå¹¶
- **Data Service**: å¤„ç†ç”¨æˆ·æ•°æ®å’Œåˆ†æ
- **Sharedæ¨¡å—**: å…±äº«çš„æ•°æ®æ¨¡å‹ã€å·¥å…·ç±»å’Œé…ç½®

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.11+
- **æ¡†æ¶**: FastAPI 0.104+
- **æ•°æ®åº“**: PostgreSQL 15+
- **ç¼“å­˜**: Redis 7+
- **ORM**: SQLAlchemy 2.0+
- **è®¤è¯**: JWT (python-jose)

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒè¦æ±‚

```bash
Python >= 3.11
PostgreSQL >= 15
Redis >= 7
```

### 2. é¡¹ç›®åˆå§‹åŒ–

```bash
# 1. è¿›å…¥backendç›®å½•
cd backend

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# 3. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 4. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 5. å®‰è£…å„æœåŠ¡çš„ä¾èµ–
cd services/agent_service
pip install -r requirements.txt
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `.env.example`ï¼‰ï¼š

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost:5432/directorai

# Redis
REDIS_URL=redis://localhost:6379/0

# JWT
SECRET_KEY=your-secret-key-here-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60

# API Keys
GLM_API_KEY=your-glm-api-key
TUZI_API_KEY=your-tuzi-api-key
GEMINI_API_KEY=your-gemini-api-key
```

### 4. æ•°æ®åº“åˆå§‹åŒ–

```bash
# åˆ›å»ºæ•°æ®åº“
createdb directorai

# è¿è¡Œè¿ç§»è„šæœ¬
psql -U postgres -d directorai -f infrastructure/database/migrations/001_initial.sql
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ api_gateway/              # APIç½‘å…³ âœ…
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.py          # æœåŠ¡å…¥å£ âœ…
â”‚   â”‚   â”œâ”€â”€ config/          # é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ settings.py  # é…ç½®ç®¡ç† âœ…
â”‚   â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py      # è®¤è¯ä¸­é—´ä»¶ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ rate_limit.py # é™æµä¸­é—´ä»¶ âœ…
â”‚   â”‚   â”‚   â””â”€â”€ cors.py      # CORSä¸­é—´ä»¶ âœ…
â”‚   â”‚   â””â”€â”€ routes/          # è·¯ç”±
â”‚   â”‚       â””â”€â”€ gateway.py   # ç½‘å…³è·¯ç”± âœ…
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ agent_service/       # AgentæœåŠ¡ â­
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py      # æœåŠ¡å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ api/         # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py           # è®¤è¯API âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversations.py  # å¯¹è¯API âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ messages.py       # æ¶ˆæ¯API âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tasks.py          # ä»»åŠ¡API âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ screenplays.py    # å‰§æœ¬API âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth_service.py           # è®¤è¯æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_service.py   # å¯¹è¯æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ message_service.py        # æ¶ˆæ¯æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ task_service.py           # ä»»åŠ¡æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ screenplay_service.py     # å‰§æœ¬æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â””â”€â”€ clients/     # ç¬¬ä¸‰æ–¹APIå®¢æˆ·ç«¯
â”‚   â”‚   â”‚       â””â”€â”€ glm_client.py     # GLMå®¢æˆ·ç«¯ âœ…
â”‚   â”‚   â””â”€â”€ requirements.txt
â”‚   â”œâ”€â”€ media_service/       # åª’ä½“æœåŠ¡ âœ…
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py      # æœåŠ¡å…¥å£ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ api/         # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ images.py        # å›¾ç‰‡API âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ videos.py        # è§†é¢‘API âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ image_service.py  # å›¾ç‰‡æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ video_service.py  # è§†é¢‘æœåŠ¡ âœ…
â”‚   â”‚   â”‚   â””â”€â”€ clients/     # ç¬¬ä¸‰æ–¹APIå®¢æˆ·ç«¯
â”‚   â”‚   â”‚       â”œâ”€â”€ tuzi_client.py    # Tuziå®¢æˆ·ç«¯ âœ…
â”‚   â”‚   â”‚       â””â”€â”€ gemini_client.py  # Geminiå®¢æˆ·ç«¯ âœ…
â”‚   â”‚   â””â”€â”€ requirements.txt
â”‚   â””â”€â”€ data_service/        # æ•°æ®æœåŠ¡ âœ…
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ main.py      # æœåŠ¡å…¥å£ âœ…
â”‚       â”‚   â”œâ”€â”€ api/         # APIè·¯ç”±
â”‚       â”‚   â”‚   â”œâ”€â”€ users.py           # ç”¨æˆ·æ•°æ®API âœ…
â”‚       â”‚   â”‚   â””â”€â”€ analytics.py      # æ•°æ®åˆ†æAPI âœ…
â”‚       â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
â”‚       â”‚   â”‚   â”œâ”€â”€ user_service.py           # ç”¨æˆ·æœåŠ¡ âœ…
â”‚       â”‚   â”‚   â””â”€â”€ analytics_service.py      # åˆ†ææœåŠ¡ âœ…
â”‚       â”‚   â””â”€â”€ repositories/ # æ•°æ®è®¿é—®å±‚
â”‚       â”‚       â”œâ”€â”€ user_repository.py        # ç”¨æˆ·æ•°æ®è®¿é—® âœ…
â”‚       â”‚       â”œâ”€â”€ conversation_repository.py # å¯¹è¯æ•°æ®è®¿é—® âœ…
â”‚       â”‚       â””â”€â”€ task_repository.py        # ä»»åŠ¡æ•°æ®è®¿é—® âœ…
â”‚       â””â”€â”€ requirements.txt
â”œâ”€â”€ shared/                   # å…±äº«æ¨¡å— âœ…
â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ conversation.py
â”‚   â”‚   â”œâ”€â”€ message.py
â”‚   â”‚   â”œâ”€â”€ task.py
â”‚   â”‚   â”œâ”€â”€ screenplay.py
â”‚   â”‚   â””â”€â”€ db_models.py     # SQLAlchemyæ¨¡å‹
â”‚   â”œâ”€â”€ utils/               # å·¥å…·ç±»
â”‚   â”‚   â”œâ”€â”€ logger.py
â”‚   â”‚   â””â”€â”€ exceptions.py
â”‚   â””â”€â”€ config/              # é…ç½®
â”‚       â”œâ”€â”€ database.py
â”‚       â””â”€â”€ redis.py
â”œâ”€â”€ infrastructure/          # åŸºç¡€è®¾æ–½ âœ…
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”‚       â””â”€â”€ 001_initial.sql
â”‚   â””â”€â”€ docker/              # Dockeré…ç½® âœ…
â”‚       â”œâ”€â”€ docker-compose.yml      # ç”Ÿäº§ç¯å¢ƒé…ç½® âœ…
â”‚       â”œâ”€â”€ docker-compose.dev.yml  # å¼€å‘ç¯å¢ƒé…ç½® âœ…
â”‚       â”œâ”€â”€ start.sh                # å¯åŠ¨è„šæœ¬ âœ…
â”‚       â”œâ”€â”€ start.bat               # å¯åŠ¨è„šæœ¬(Windows) âœ…
â”‚       â”œâ”€â”€ stop.sh                 # åœæ­¢è„šæœ¬ âœ…
â”‚       â”œâ”€â”€ stop.bat                # åœæ­¢è„šæœ¬(Windows) âœ…
â”‚       â””â”€â”€ README.md               # Dockerä½¿ç”¨æ–‡æ¡£ âœ…
â””â”€â”€ tests/                   # æµ‹è¯•ï¼ˆå¾…å®ç°ï¼‰

å›¾ä¾‹: âœ… å·²å®Œæˆ | â³ éƒ¨åˆ†å®Œæˆ | âŒ å¾…å®ç°
```

---

## ğŸ“ å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°çš„APIè·¯ç”±

**æ­¥éª¤ï¼š**

1. åœ¨ `services/agent_service/src/api/` åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. å®ç°è·¯ç”±å‡½æ•°
3. åœ¨ `main.py` ä¸­æ³¨å†Œè·¯ç”±

**ç¤ºä¾‹ï¼š**

```python
# services/agent_service/src/api/example.py
from fastapi import APIRouter, Depends
from services.agent_service.src.api.auth import get_current_user

router = APIRouter(prefix="/example", tags=["ç¤ºä¾‹"])

@router.get("")
async def get_example(current_user = Depends(get_current_user)):
    return {"message": "ç¤ºä¾‹API"}

# services/agent_service/src/main.py
from services.agent_service.src.api import example
app.include_router(example.router, prefix="/api/v1")
```

### 2. æ·»åŠ æ–°çš„æœåŠ¡ç±»

**æ­¥éª¤ï¼š**

1. åœ¨ `services/agent_service/src/services/` åˆ›å»ºæœåŠ¡æ–‡ä»¶
2. å®ç°ä¸šåŠ¡é€»è¾‘
3. åœ¨APIè·¯ç”±ä¸­è°ƒç”¨æœåŠ¡

**ç¤ºä¾‹ï¼š**

```python
# services/agent_service/src/services/example_service.py
from sqlalchemy.orm import Session

class ExampleService:
    def __init__(self, db: Session):
        self.db = db
    
    def do_something(self):
        # ä¸šåŠ¡é€»è¾‘
        pass
```

### 3. æ·»åŠ æ•°æ®åº“æ¨¡å‹

**æ­¥éª¤ï¼š**

1. åœ¨ `shared/models/db_models.py` æ·»åŠ SQLAlchemyæ¨¡å‹
2. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
3. åœ¨ `shared/models/` æ·»åŠ Pydanticæ¨¡å‹ï¼ˆå¦‚éœ€è¦ï¼‰

### 4. æ·»åŠ ç¬¬ä¸‰æ–¹APIå®¢æˆ·ç«¯

**æ­¥éª¤ï¼š**

1. åœ¨å¯¹åº”çš„serviceçš„ `clients/` ç›®å½•åˆ›å»ºå®¢æˆ·ç«¯æ–‡ä»¶
2. å®ç°APIè°ƒç”¨æ–¹æ³•
3. åœ¨æœåŠ¡ç±»ä¸­ä½¿ç”¨å®¢æˆ·ç«¯

---

## ğŸ”Œ APIå®ç°çŠ¶æ€

### API Gateway

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é…ç½®ç®¡ç† | âœ… | æœåŠ¡åœ°å€ã€é™æµè§„åˆ™ã€CORSé…ç½® |
| è®¤è¯ä¸­é—´ä»¶ | âœ… | JWT TokenéªŒè¯ |
| é™æµä¸­é—´ä»¶ | âœ… | åŸºäºIPå’Œç”¨æˆ·IDçš„è¯·æ±‚é™æµ |
| CORSä¸­é—´ä»¶ | âœ… | è·¨åŸŸè¯·æ±‚æ”¯æŒ |
| è·¯ç”±è½¬å‘ | âœ… | è‡ªåŠ¨è½¬å‘è¯·æ±‚åˆ°å¯¹åº”æœåŠ¡ |
| å¥åº·æ£€æŸ¥ | âœ… | ç½‘å…³å’ŒæœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§ |

### Agent Service

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è®¤è¯API | âœ… | æ³¨å†Œã€ç™»å½•ã€è·å–ç”¨æˆ·ä¿¡æ¯ |
| å¯¹è¯API | âœ… | åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤å¯¹è¯ |
| æ¶ˆæ¯API | âœ… | è·å–æ¶ˆæ¯åˆ—è¡¨ã€åˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤æ¶ˆæ¯ |
| ä»»åŠ¡API | âœ… | åˆ›å»ºã€æŸ¥è¯¢ä»»åŠ¡ã€è·å–è¿›åº¦ |
| å‰§æœ¬API | âœ… | ç”Ÿæˆè‰ç¨¿ã€ç¡®è®¤ã€æŸ¥è¯¢ã€æ›´æ–° |
| WebSocket | âœ… | å®æ—¶æ¨é€ä»»åŠ¡è¿›åº¦ã€æ¶ˆæ¯é€šçŸ¥ |

### Media Service

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Tuziå®¢æˆ·ç«¯ | âœ… | è§†é¢‘ç”Ÿæˆå®¢æˆ·ç«¯ |
| Geminiå®¢æˆ·ç«¯ | âœ… | å›¾ç‰‡ç”Ÿæˆå®¢æˆ·ç«¯ |
| å›¾ç‰‡API | âœ… | å›¾ç‰‡ç”ŸæˆAPI |
| è§†é¢‘API | âœ… | è§†é¢‘ç”ŸæˆAPI |

### Data Service

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç”¨æˆ·æ•°æ®API | âœ… | è·å–ã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ç”¨æˆ·ç»Ÿè®¡ |
| æ•°æ®åˆ†æAPI | âœ… | ç³»ç»Ÿæ¦‚è§ˆã€ä»»åŠ¡åˆ†æã€å¯¹è¯åˆ†æã€åª’ä½“åˆ†æ |
| æ•°æ®è®¿é—®å±‚ | âœ… | ç”¨æˆ·ã€å¯¹è¯ã€ä»»åŠ¡æ•°æ®è®¿é—® |
| åˆ†ææœåŠ¡ | âœ… | ç»Ÿè®¡åˆ†ææœåŠ¡ |

### ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯

| å®¢æˆ·ç«¯ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| GLMå®¢æˆ·ç«¯ | âœ… | å‰§æœ¬ç”Ÿæˆ |
| Tuziå®¢æˆ·ç«¯ | âœ… | è§†é¢‘ç”Ÿæˆ |
| Geminiå®¢æˆ·ç«¯ | âœ… | å›¾ç‰‡ç”Ÿæˆ |

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»

### åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ–°éƒ¨ç½²ï¼‰

æœ¬é¡¹ç›®ä¸ºæ–°éƒ¨ç½²ï¼Œä½¿ç”¨å•ä¸€çš„åˆå§‹è¿ç§»æ–‡ä»¶åˆ›å»ºå®Œæ•´çš„æ•°æ®åº“ç»“æ„ã€‚

```bash
# 1. åˆ›å»ºæ•°æ®åº“
createdb directorai

# 2. è¿è¡Œåˆå§‹è¿ç§»è„šæœ¬ï¼ˆåŒ…å«æ‰€æœ‰è¡¨ç»“æ„å’Œç´¢å¼•ï¼‰
psql -U postgres -d directorai -f infrastructure/database/migrations/001_initial.sql
```

**æ³¨æ„**ï¼š`001_initial.sql` å·²åŒ…å«æ‰€æœ‰è¡¨ç»“æ„ã€ç´¢å¼•å’Œçº¦æŸï¼Œé€‚ç”¨äºæ–°éƒ¨ç½²åœºæ™¯ã€‚

---

## ğŸ³ Dockeréƒ¨ç½²

### å¿«é€Ÿå¼€å§‹

1. **é…ç½®ç¯å¢ƒå˜é‡**

```bash
cd backend
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡
```

2. **å¯åŠ¨æœåŠ¡**

```bash
# ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰€æœ‰æœåŠ¡ï¼‰
cd infrastructure/docker
./start.sh prod  # Linux/Mac
start.bat prod   # Windows

# å¼€å‘ç¯å¢ƒï¼ˆä»…åŸºç¡€è®¾æ–½ï¼‰
./start.sh dev    # Linux/Mac
start.bat dev     # Windows
```

3. **åœæ­¢æœåŠ¡**

```bash
./stop.sh [dev|prod]  # Linux/Mac
stop.bat [dev|prod]   # Windows
```

### æœåŠ¡ç«¯å£

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| API Gateway | 8000 | ç»Ÿä¸€APIå…¥å£ |
| Agent Service | 8001 | Agentä¸šåŠ¡æœåŠ¡ |
| Media Service | 8002 | åª’ä½“æœåŠ¡ |
| Data Service | 8003 | æ•°æ®æœåŠ¡ |
| PostgreSQL | 5432 | æ•°æ®åº“ |
| Redis | 6379 | ç¼“å­˜ |
| MinIO | 9000 | å¯¹è±¡å­˜å‚¨ |
| MinIO Console | 9001 | MinIOç®¡ç†ç•Œé¢ |

### è¯¦ç»†æ–‡æ¡£

æ›´å¤šDockeréƒ¨ç½²ä¿¡æ¯ï¼Œè¯·å‚è€ƒï¼š[infrastructure/docker/README.md](./infrastructure/docker/README.md)

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨Agent Service
cd services/agent_service
uvicorn src.main:app --reload --port 8001

# è®¿é—®APIæ–‡æ¡£
# http://localhost:8001/docs
```

### APIæµ‹è¯•

ä½¿ç”¨FastAPIè‡ªåŠ¨ç”Ÿæˆçš„Swaggeræ–‡æ¡£ï¼š

- Swagger UI: `http://localhost:8001/docs`
- ReDoc: `http://localhost:8001/redoc`

### æµ‹è¯•è®¤è¯

1. æ³¨å†Œç”¨æˆ·ï¼š`POST /api/v1/auth/register`
2. ç™»å½•è·å–Tokenï¼š`POST /api/v1/auth/login`
3. ä½¿ç”¨Tokenè®¿é—®å—ä¿æŠ¤æ¥å£ï¼šåœ¨Headerä¸­æ·»åŠ  `Authorization: Bearer {token}`

### å•å…ƒæµ‹è¯•

æµ‹è¯•æ¡†æ¶å·²æ­å»ºå®Œæˆï¼Œä½¿ç”¨pytestè¿›è¡Œæµ‹è¯•ã€‚

#### è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install -r requirements-test.txt

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/ -m unit

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/ -m integration

# æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=services --cov=shared --cov-report=html
```

#### æµ‹è¯•è¦†ç›–æƒ…å†µ

å½“å‰æµ‹è¯•è¦†ç›–ç‡ï¼š~70%

| æœåŠ¡ | æµ‹è¯•ç”¨ä¾‹æ•° | çŠ¶æ€ |
|------|-----------|------|
| è®¤è¯æœåŠ¡ | 9 | âœ… å®Œæˆ |
| å¯¹è¯æœåŠ¡ | 15 | âœ… å®Œæˆ |
| ä»»åŠ¡æœåŠ¡ | 14 | âœ… å®Œæˆ |
| å‰§æœ¬æœåŠ¡ | 11 | âœ… å®Œæˆ |
| åª’ä½“æœåŠ¡ | 16 | âœ… å®Œæˆ |
| æ¶ˆæ¯æœåŠ¡ | 0 | â³ å¾…è¡¥å…… |
| æ•°æ®åˆ†ææœåŠ¡ | 0 | â³ å¾…è¡¥å…… |

è¯¦ç»†æµ‹è¯•æ–‡æ¡£è¯·å‚è€ƒï¼š[tests/README.md](./tests/README.md)

---

## â“ å¸¸è§é—®é¢˜

### 1. å¯¼å…¥é”™è¯¯

**é—®é¢˜**: `ModuleNotFoundError: No module named 'services'`

**è§£å†³**: 
- ç¡®ä¿åœ¨backendç›®å½•ä¸‹è¿è¡Œ
- æ£€æŸ¥ `sys.path` é…ç½®
- ä½¿ç”¨ç›¸å¯¹å¯¼å…¥æˆ–æ­£ç¡®è®¾ç½®PYTHONPATH

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜**: `sqlalchemy.exc.OperationalError`

**è§£å†³**:
- æ£€æŸ¥ `DATABASE_URL` é…ç½®
- ç¡®è®¤PostgreSQLæœåŠ¡è¿è¡Œ
- æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™

### 3. Redisè¿æ¥å¤±è´¥

**é—®é¢˜**: `redis.exceptions.ConnectionError`

**è§£å†³**:
- æ£€æŸ¥ `REDIS_URL` é…ç½®
- ç¡®è®¤RedisæœåŠ¡è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œè¿æ¥

### 4. JWT Tokenæ— æ•ˆ

**é—®é¢˜**: `AuthenticationError: Token æ— æ•ˆ`

**è§£å†³**:
- æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
- ç¡®è®¤SECRET_KEYé…ç½®æ­£ç¡®
- æ£€æŸ¥Tokenæ ¼å¼ï¼ˆBearer {token}ï¼‰

### 5. ç¬¬ä¸‰æ–¹APIè°ƒç”¨å¤±è´¥

**é—®é¢˜**: `httpx.HTTPStatusError`

**è§£å†³**:
- æ£€æŸ¥API Keyé…ç½®
- æŸ¥çœ‹é”™è¯¯å“åº”è¯¦æƒ…
- ç¡®è®¤APIæœåŠ¡å¯ç”¨

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [åç«¯å·¥ç¨‹å®æ–½æ–¹æ¡ˆ](../docs/åç«¯å·¥ç¨‹å®æ–½æ–¹æ¡ˆ.md)
- [APIæ¥å£è®¾è®¡æ–‡æ¡£](../docs/APIæ¥å£è®¾è®¡æ–‡æ¡£.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../docs/æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemyæ–‡æ¡£](https://docs.sqlalchemy.org/)

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### ä¼˜å…ˆçº§é«˜

1. âœ… å®Œæˆç›®å½•é‡å‘½åï¼ˆè¿å­—ç¬¦æ”¹ä¸ºä¸‹åˆ’çº¿ï¼‰
2. âœ… å®ç°è®¤è¯APIå’ŒæœåŠ¡
3. âœ… å®ç°å¯¹è¯APIå’ŒæœåŠ¡
4. âœ… å®ç°ä»»åŠ¡APIå’ŒæœåŠ¡
5. âœ… å®ç°ç¬¬ä¸‰æ–¹APIå®¢æˆ·ç«¯
6. âœ… å®ç°å‰§æœ¬APIå’ŒæœåŠ¡
7. âœ… å®ç°Media Serviceçš„APIï¼ˆå›¾ç‰‡/è§†é¢‘ç”Ÿæˆï¼‰
8. âœ… å®ç°WebSocketå®æ—¶æ¨é€

### ä¼˜å…ˆçº§ä¸­

1. âœ… å®ç°Data Service
2. âœ… å®ç°API Gateway
3. âœ… æ·»åŠ å•å…ƒæµ‹è¯• â¬†ï¸ æ ¸å¿ƒæœåŠ¡æµ‹è¯•å·²å®Œæˆï¼ˆ2026-01-13ï¼‰
   - âœ… è®¤è¯æœåŠ¡æµ‹è¯•ï¼ˆ9ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - âœ… å¯¹è¯æœåŠ¡æµ‹è¯•ï¼ˆ15ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - âœ… ä»»åŠ¡æœåŠ¡æµ‹è¯•ï¼ˆ14ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - âœ… å‰§æœ¬æœåŠ¡æµ‹è¯•ï¼ˆ11ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - âœ… åª’ä½“æœåŠ¡æµ‹è¯•ï¼ˆ16ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - æµ‹è¯•è¦†ç›–ç‡ï¼š~70%
4. â³ æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆéƒ¨åˆ†å®Œæˆï¼šè®¤è¯APIæµ‹è¯•å·²å®Œæˆï¼‰
5. âœ… Dockeré…ç½®
6. âœ… éƒ¨ç½²é…ç½®

### ä¼˜å…ˆçº§ä½

1. âŒ æ€§èƒ½ä¼˜åŒ–
2. âŒ ç›‘æ§å’Œæ—¥å¿—
3. âŒ æ–‡æ¡£å®Œå–„

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2026-01-12

- âœ… å®ç°æ¶ˆæ¯ç®¡ç†æ¨¡å—ï¼ˆMessages APIï¼‰
  - å®ç°æ¶ˆæ¯æœåŠ¡å±‚ï¼ˆMessageServiceï¼‰- æ¶ˆæ¯æŸ¥è¯¢ã€åˆ›å»ºã€åˆ é™¤ç­‰ä¸šåŠ¡é€»è¾‘
  - å®ç°æ¶ˆæ¯APIè·¯ç”±ï¼ˆmessages.pyï¼‰- GET/POST/DELETEæ¥å£
  - æ”¯æŒåˆ†é¡µæŸ¥è¯¢å’ŒæŒ‰æ—¶é—´ç­›é€‰ï¼ˆbeforeå‚æ•°ï¼‰
  - è‡ªåŠ¨æ›´æ–°å¯¹è¯çš„æ¶ˆæ¯è®¡æ•°å’Œæœ€åè®¿é—®æ—¶é—´
  - åœ¨main.pyä¸­æ³¨å†Œæ¶ˆæ¯è·¯ç”±

- âœ… å®ç°Dockeré…ç½®å’Œéƒ¨ç½²é…ç½®
  - åˆ›å»ºå„æœåŠ¡çš„Dockerfileï¼ˆapi_gatewayã€agent_serviceã€media_serviceã€data_serviceï¼‰
  - åˆ›å»ºdocker-compose.ymlï¼ˆç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ŒåŒ…å«æ‰€æœ‰æœåŠ¡ï¼‰
  - åˆ›å»ºdocker-compose.dev.ymlï¼ˆå¼€å‘ç¯å¢ƒé…ç½®ï¼Œä»…åŸºç¡€è®¾æ–½ï¼‰
  - åˆ›å»ºå¯åŠ¨/åœæ­¢è„šæœ¬ï¼ˆstart.shã€start.batã€stop.shã€stop.batï¼‰
  - åˆ›å»º.dockerignoreæ–‡ä»¶
  - åˆ›å»º.env.exampleç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
  - åˆ›å»ºDockeréƒ¨ç½²æ–‡æ¡£ï¼ˆinfrastructure/docker/README.mdï¼‰

- âœ… å®ç°API Gatewayï¼ˆAPIç½‘å…³ï¼‰
  - å®ç°é…ç½®ç®¡ç†ï¼ˆæœåŠ¡åœ°å€ã€é™æµè§„åˆ™ã€CORSé…ç½®ï¼‰
  - å®ç°è®¤è¯ä¸­é—´ä»¶ï¼ˆJWT TokenéªŒè¯ï¼‰
  - å®ç°é™æµä¸­é—´ä»¶ï¼ˆåŸºäºIPå’Œç”¨æˆ·IDçš„è¯·æ±‚é™æµï¼‰
  - å®ç°CORSä¸­é—´ä»¶ï¼ˆè·¨åŸŸè¯·æ±‚æ”¯æŒï¼‰
  - å®ç°è·¯ç”±è½¬å‘ï¼ˆè‡ªåŠ¨è½¬å‘è¯·æ±‚åˆ°å¯¹åº”æœåŠ¡ï¼‰
  - å®ç°å¥åº·æ£€æŸ¥ï¼ˆç½‘å…³å’ŒæœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§ï¼‰

- âœ… å®ç°Data Serviceï¼ˆæ•°æ®æœåŠ¡ï¼‰
  - å®ç°ç”¨æˆ·æ•°æ®APIï¼ˆè·å–ã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ç”¨æˆ·ç»Ÿè®¡ï¼‰
  - å®ç°æ•°æ®åˆ†æAPIï¼ˆç³»ç»Ÿæ¦‚è§ˆã€ä»»åŠ¡åˆ†æã€å¯¹è¯åˆ†æã€åª’ä½“åˆ†æï¼‰
  - å®ç°æ•°æ®è®¿é—®å±‚ï¼ˆUserRepositoryã€ConversationRepositoryã€TaskRepositoryï¼‰
  - å®ç°æœåŠ¡å±‚ï¼ˆUserServiceã€AnalyticsServiceï¼‰

### 2025-01-12

- âœ… åˆ›å»ºé¡¹ç›®åŸºç¡€ç»“æ„
- âœ… å®ç°å…±äº«æ¨¡å—ï¼ˆmodelsã€utilsã€configï¼‰
- âœ… å®ç°æ•°æ®åº“æ¨¡å‹å’Œè¿ç§»è„šæœ¬
- âœ… å®ç°è®¤è¯APIå’ŒæœåŠ¡
- âœ… å®ç°å¯¹è¯APIå’ŒæœåŠ¡
- âœ… å®ç°ä»»åŠ¡APIå’ŒæœåŠ¡
- âœ… å®ç°å‰§æœ¬APIå’ŒæœåŠ¡
- âœ… å®ç°GLMã€Tuziã€Geminiå®¢æˆ·ç«¯
- âœ… ç›®å½•é‡å‘½åï¼ˆè¿å­—ç¬¦æ”¹ä¸ºä¸‹åˆ’çº¿ï¼‰
- âœ… åˆ›å»ºå¼€å‘æ–½å·¥æ–‡æ¡£
- âœ… å®ç°Media Service APIï¼ˆå›¾ç‰‡/è§†é¢‘ç”Ÿæˆï¼‰
- âœ… å®ç°WebSocketå®æ—¶æ¨é€
- âœ… å®ç°API Gatewayï¼ˆç»Ÿä¸€å…¥å£ã€è®¤è¯ã€é™æµã€è·¯ç”±è½¬å‘ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.2  
**æœ€åæ›´æ–°**: 2026-01-12  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
